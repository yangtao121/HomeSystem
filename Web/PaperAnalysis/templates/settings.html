{% extends "base.html" %}

{% block title %}æ¨¡å‹è®¾ç½® - PaperAnalysis{% endblock %}

{% block content %}
<!-- é¡¶éƒ¨æ¸å˜èƒŒæ™¯åŒºåŸŸ -->
<div class="hero-section">
    <div class="container-fluid">
        <!-- é¡µé¢æ ‡é¢˜å’Œæè¿° -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="hero-title-wrapper">
                    <h1 class="hero-title animated-title">
                        <i class="bi bi-sliders me-3 hero-icon"></i>
                        <span class="title-gradient">æ¨¡å‹è®¾ç½®</span>
                    </h1>
                    <div class="hero-title-secondary">
                        <span class="title-subtitle">Model Configuration</span>
                    </div>
                    <p class="hero-subtitle animated-subtitle">ğŸ¤– é…ç½®ç³»ç»Ÿä½¿ç”¨çš„LLMæ¨¡å‹å’Œæ·±åº¦åˆ†æå‚æ•°ï¼Œä¼˜åŒ–è®ºæ–‡åˆ†ææ€§èƒ½ âš™ï¸</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid main-content">

<form id="settingsForm">
    <!-- LLMæ¨¡å‹é…ç½®å¡ç‰‡ -->
    <div class="modern-settings-card" data-aos="fade-up" data-aos-delay="100">
        <div class="settings-card-header">
            <div class="settings-icon-wrapper">
                <div class="settings-icon-bg"></div>
                <i class="bi bi-cpu settings-icon"></i>
            </div>
            <div class="settings-content">
                <h4 class="settings-title">LLMæ¨¡å‹é…ç½®</h4>
                <p class="settings-subtitle">é…ç½®ç”¨äºè®ºæ–‡åˆ†æçš„è¯­è¨€æ¨¡å‹å’Œå‚æ•°</p>
            </div>
        </div>
        <div class="settings-card-body">
            <div class="modern-alert modern-alert-info">
                <div class="alert-icon">
                    <i class="bi bi-info-circle"></i>
                </div>
                <div class="alert-content">
                    <div class="alert-title">æ¨¡å‹ä½¿ç”¨è¯´æ˜</div>
                    <div class="alert-text">è¿™é‡Œé…ç½®çš„æ¨¡å‹å°†è¢«è®ºæ–‡æµè§ˆé¡µé¢çš„"å¼€å§‹æ·±åº¦åˆ†æ"åŠŸèƒ½å’Œæ·±åº¦åˆ†ææŠ¥å‘Šé¡µé¢çš„"é‡æ–°åˆ†æ"åŠŸèƒ½å…±åŒä½¿ç”¨ã€‚</div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="llm_model_name" class="form-label">é»˜è®¤LLMæ¨¡å‹ *</label>
                    <select class="form-select" id="llm_model_name" name="llm_model_name" required>
                        {% if available_models %}
                            {% for model in available_models %}
                            <option value="{{ model }}" 
                                    {% if model == default_config.llm_model_name %}selected{% endif %}>
                                {{ model }}
                            </option>
                            {% endfor %}
                        {% else %}
                            <option value="">åŠ è½½ä¸­...</option>
                        {% endif %}
                    </select>
                    <div class="form-help">é€‰æ‹©ç”¨äºè®ºæ–‡åˆ†æçš„é»˜è®¤è¯­è¨€æ¨¡å‹</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="relevance_threshold" class="form-label">ç›¸å…³æ€§é˜ˆå€¼</label>
                    <div class="slider-container">
                        <input type="range" class="form-range range-input" id="relevance_threshold" 
                               name="relevance_threshold" min="0" max="1" step="0.1" 
                               value="{{ default_config.relevance_threshold if default_config else '0.7' }}">
                        <div class="d-flex justify-content-between">
                            <small>0.0</small>
                            <span class="range-value" id="relevance_value">{{ default_config.relevance_threshold if default_config else '0.7' }}</span>
                            <small>1.0</small>
                        </div>
                    </div>
                    <div class="form-help">åªæœ‰è¶…è¿‡æ­¤ç›¸å…³æ€§åˆ†æ•°çš„è®ºæ–‡æ‰ä¼šè¢«ä¿ç•™</div>
                </div>
            </div>
            
            <!-- é«˜çº§æ¨¡å‹é…ç½® -->
            <div class="mt-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enable_advanced_models">
                    <label class="form-check-label" for="enable_advanced_models">
                        <strong>å¯ç”¨é«˜çº§æ¨¡å‹é…ç½®</strong>
                    </label>
                </div>
                <div class="form-help">å¯¹ä¸åŒåˆ†æä»»åŠ¡ä½¿ç”¨ä¸“é—¨çš„æ¨¡å‹</div>
            </div>
            
            <div id="advanced_models_section" class="mt-3" style="display: none;">
                <div class="card">
                    <div class="card-body">
                        <h6><i class="fas fa-cogs me-2"></i>ä¸“ç”¨æ¨¡å‹é…ç½®</h6>
                        <p class="text-muted small mb-3">ä¸ºä¸åŒåˆ†æä»»åŠ¡é€‰æ‹©ä¸“é—¨çš„æ¨¡å‹ã€‚ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤æ¨¡å‹ã€‚</p>
                        <div class="modern-alert modern-alert-success small mb-3">
                            <div class="alert-icon">
                                <i class="bi bi-lightbulb"></i>
                            </div>
                            <div class="alert-content">
                                <div class="alert-title">é‡è¦æç¤º</div>
                                <div class="alert-text">è¿™é‡Œè®¾ç½®çš„"æ·±åº¦åˆ†ææ¨¡å‹"å’Œ"è§†è§‰æ¨¡å‹"å°†è¢«è®ºæ–‡æµè§ˆå’Œæ·±åº¦åˆ†ææŠ¥å‘Šé¡µé¢çš„åˆ†æåŠŸèƒ½ä½¿ç”¨ã€‚</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="abstract_analysis_model" class="form-label">æ‘˜è¦åˆ†ææ¨¡å‹</label>
                                <select class="form-select" id="abstract_analysis_model" name="abstract_analysis_model">
                                    <option value="">ä½¿ç”¨é»˜è®¤æ¨¡å‹</option>
                                    {% if available_models %}
                                        {% for model in available_models %}
                                        <option value="{{ model }}">{{ model }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="form-help">ç”¨äºåˆæ­¥æ‘˜è¦ç›¸å…³æ€§åˆ†æ</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="full_paper_analysis_model" class="form-label">å®Œæ•´è®ºæ–‡åˆ†ææ¨¡å‹</label>
                                <select class="form-select" id="full_paper_analysis_model" name="full_paper_analysis_model">
                                    <option value="">ä½¿ç”¨é»˜è®¤æ¨¡å‹</option>
                                    {% if available_models %}
                                        {% for model in available_models %}
                                        <option value="{{ model }}">{{ model }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="form-help">ç”¨äºå®Œæ•´è®ºæ–‡æ·±åº¦åˆ†æ</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="deep_analysis_model" class="form-label">æ·±åº¦åˆ†ææ¨¡å‹</label>
                                <select class="form-select" id="deep_analysis_model" name="deep_analysis_model">
                                    <option value="">ä½¿ç”¨é»˜è®¤æ¨¡å‹ (deepseek.DeepSeek_V3)</option>
                                    {% if available_models %}
                                        {% for model in available_models %}
                                        <option value="{{ model }}">{{ model }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="form-help">ç”¨äºè®ºæ–‡æ·±åº¦åˆ†æå’Œç»“æ„åŒ–æå–</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vision_model" class="form-label">è§†è§‰æ¨¡å‹</label>
                                <select class="form-select" id="vision_model" name="vision_model">
                                    <option value="">ä½¿ç”¨é»˜è®¤æ¨¡å‹ (ollama.Qwen2_5_VL_7B)</option>
                                    {% if available_models %}
                                        {% for model in available_models %}
                                        <option value="{{ model }}">{{ model }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="form-help">ç”¨äºå›¾åƒå’Œå›¾è¡¨è¯†åˆ«åˆ†æ</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="video_analysis_model" class="form-label">è§†é¢‘åˆ†ææ¨¡å‹</label>
                                <select class="form-select" id="video_analysis_model" name="video_analysis_model">
                                    <option value="">ä½¿ç”¨é»˜è®¤æ¨¡å‹ (ollama.Qwen3_30B)</option>
                                    {% if available_models %}
                                        {% for model in available_models %}
                                        <option value="{{ model }}">{{ model }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="form-help">ç”¨äºè§†é¢‘èµ„æºåˆ†æå’Œå†…å®¹ç†è§£</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·±åº¦åˆ†æé…ç½®å¡ç‰‡ -->
    <div class="modern-settings-card" data-aos="fade-up" data-aos-delay="200">
        <div class="settings-card-header">
            <div class="settings-icon-wrapper">
                <div class="settings-icon-bg"></div>
                <i class="bi bi-graph-up settings-icon"></i>
            </div>
            <div class="settings-content">
                <h4 class="settings-title">æ·±åº¦åˆ†æé…ç½®</h4>
                <p class="settings-subtitle">é…ç½®æ·±åº¦åˆ†æçš„è§¦å‘æ¡ä»¶å’Œæ‰§è¡Œå‚æ•°</p>
            </div>
        </div>
        <div class="settings-card-body">
            <div class="modern-alert modern-alert-warning">
                <div class="alert-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="alert-content">
                    <div class="alert-title">é…ç½®æ³¨æ„äº‹é¡¹</div>
                    <div class="alert-text">æ·±åº¦åˆ†æå’Œè§†è§‰æ¨¡å‹çš„é€‰æ‹©åœ¨ä¸Šæ–¹çš„"LLMæ¨¡å‹é…ç½®"ä¸­çš„é«˜çº§æ¨¡å‹é…ç½®éƒ¨åˆ†è¿›è¡Œè®¾ç½®ã€‚è¿™é‡Œä¸»è¦é…ç½®åˆ†æå‚æ•°å’Œé˜ˆå€¼ã€‚</div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enable_deep_analysis" 
                               name="enable_deep_analysis" checked>
                        <label class="form-check-label" for="enable_deep_analysis">
                            <strong>å¯ç”¨æ·±åº¦åˆ†æ</strong>
                        </label>
                    </div>
                    <div class="form-help">å¯¹é«˜ç›¸å…³æ€§è®ºæ–‡è¿›è¡Œæ·±åº¦åˆ†æå’Œç»“æ„åŒ–æå–</div>
                    
                    <div id="deep_analysis_options" class="mt-3">
                        <label for="deep_analysis_threshold" class="form-label">æ·±åº¦åˆ†æé˜ˆå€¼</label>
                        <div class="slider-container">
                            <input type="range" class="form-range range-input" id="deep_analysis_threshold" 
                                   name="deep_analysis_threshold" min="0" max="1" step="0.1" value="0.8">
                            <div class="d-flex justify-content-between">
                                <small>0.0</small>
                                <span class="range-value" id="deep_analysis_value">0.8</span>
                                <small>1.0</small>
                            </div>
                        </div>
                        <div class="form-help">ç›¸å…³æ€§åˆ†æ•°è¶…è¿‡æ­¤å€¼çš„è®ºæ–‡ä¼šè¿›è¡Œæ·±åº¦åˆ†æ</div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="ocr_char_limit_for_analysis" class="form-label">OCRå­—ç¬¦é™åˆ¶</label>
                    <input type="number" class="form-control" id="ocr_char_limit_for_analysis" 
                           name="ocr_char_limit_for_analysis" value="10000" 
                           min="1000" max="50000" step="1000">
                    <div class="form-help">ç”¨äºLLMåˆ†æçš„æœ€å¤§OCRå­—ç¬¦æ•°ï¼ˆé»˜è®¤10000å­—ç¬¦ï¼‰</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enable_remote_ocr" 
                               name="enable_remote_ocr">
                        <label class="form-check-label" for="enable_remote_ocr">
                            <strong>å¯ç”¨è¿œç¨‹OCRæœåŠ¡</strong>
                        </label>
                    </div>
                    <div class="form-help">ä½¿ç”¨è¿œç¨‹PaddleOCRæœåŠ¡è¿›è¡Œè®ºæ–‡æ–‡å­—è¯†åˆ«ï¼ˆéœ€è¦éƒ¨ç½²è¿œç¨‹OCRæœåŠ¡ï¼‰</div>
                    
                    <div id="remote_ocr_options" class="mt-3" style="display: none;">
                        <label for="remote_ocr_endpoint" class="form-label">è¿œç¨‹OCRæœåŠ¡åœ°å€</label>
                        <input type="url" class="form-control" id="remote_ocr_endpoint" 
                               name="remote_ocr_endpoint" value="http://localhost:5001" 
                               placeholder="http://localhost:5001">
                        <div class="form-help mb-2">è¿œç¨‹OCRæœåŠ¡çš„APIåœ°å€</div>
                        
                        <label for="remote_ocr_timeout" class="form-label">OCRè¶…æ—¶æ—¶é—´ (ç§’)</label>
                        <input type="number" class="form-control" id="remote_ocr_timeout" 
                               name="remote_ocr_timeout" value="300" 
                               min="60" max="1800" step="30">
                        <div class="form-help">è¿œç¨‹OCRè¯·æ±‚çš„æœ€å¤§ç­‰å¾…æ—¶é—´</div>
                        
                        <label for="remote_ocr_max_pages" class="form-label">OCRæœ€å¤§å¤„ç†é¡µæ•°</label>
                        <input type="number" class="form-control" id="remote_ocr_max_pages" 
                               name="remote_ocr_max_pages" value="25" 
                               min="1" max="100" step="1">
                        <div class="form-help">è¿œç¨‹OCRå¤„ç†çš„æœ€å¤§é¡µæ•°ï¼ˆç”¨äºå…ƒæ•°æ®æå–å’Œå®Œæ•´åˆ†æï¼‰</div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="analysis_timeout" class="form-label">åˆ†æè¶…æ—¶æ—¶é—´ (ç§’)</label>
                    <input type="number" class="form-control" id="analysis_timeout" name="analysis_timeout" 
                           min="300" max="1800" value="600" required>
                    <div class="form-help">å•ä¸ªè®ºæ–‡æ·±åº¦åˆ†æçš„æœ€å¤§ç­‰å¾…æ—¶é—´</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enable_video_analysis" 
                               name="enable_video_analysis">
                        <label class="form-check-label" for="enable_video_analysis">
                            <strong>å¯ç”¨è§†é¢‘åˆ†æåŠŸèƒ½</strong>
                        </label>
                    </div>
                    <div class="form-help">å¯¹è®ºæ–‡ç›¸å…³ç½‘é¡µä¸­çš„è§†é¢‘å†…å®¹è¿›è¡Œè‡ªåŠ¨ä¸‹è½½å’Œåˆ†æ</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿å­˜è®¾ç½®å¡ç‰‡ -->
    <div class="modern-settings-card" data-aos="fade-up" data-aos-delay="300">
        <div class="settings-card-header">
            <div class="settings-icon-wrapper">
                <div class="settings-icon-bg"></div>
                <i class="bi bi-check-circle settings-icon"></i>
            </div>
            <div class="settings-content">
                <h4 class="settings-title">ä¿å­˜è®¾ç½®</h4>
                <p class="settings-subtitle">ä¿®æ”¹åçš„é…ç½®å°†åº”ç”¨åˆ°åç»­çš„ä»»åŠ¡æ‰§è¡Œä¸­</p>
            </div>
        </div>
        <div class="settings-card-body">
            <div class="d-flex justify-content-end gap-3">
                <button type="button" class="btn modern-action-btn reset-btn" onclick="resetSettings()">
                    <div class="btn-icon-wrapper">
                        <i class="bi bi-arrow-counterclockwise btn-icon"></i>
                    </div>
                    <div class="btn-content">
                        <span class="btn-title">é‡ç½®è®¾ç½®</span>
                        <span class="btn-subtitle">Reset</span>
                    </div>
                </button>
                <button type="submit" class="btn modern-action-btn save-btn" id="saveBtn">
                    <div class="btn-icon-wrapper">
                        <i class="bi bi-check-lg btn-icon"></i>
                    </div>
                    <div class="btn-content">
                        <span class="btn-title">ä¿å­˜è®¾ç½®</span>
                        <span class="btn-subtitle">Save</span>
                    </div>
                </button>
            </div>
        </div>
    </div>
</form>

</div>

<!-- ç»“æœæç¤ºæ¨¡æ€æ¡† -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">è®¾ç½®ç»“æœ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
            </div>
            <div class="modal-body">
                <div id="resultContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="å…³é—­è®¾ç½®ç»“æœå¯¹è¯æ¡†">å…³é—­</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- AOS Animation Library -->
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<style>
/* ==============================================
   ç°ä»£åŒ–è®¾ç½®é¡µé¢æ ·å¼ - ä¸é¦–é¡µé£æ ¼ä¸€è‡´
============================================== */

/* æ ¹å˜é‡å®šä¹‰ - ä¸index.htmlä¿æŒä¸€è‡´ */
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
    --glass-bg: rgba(255, 255, 255, 0.15);
    --glass-border: rgba(255, 255, 255, 0.2);
    --shadow-light: 0 8px 32px rgba(31, 38, 135, 0.15);
    --shadow-medium: 0 12px 40px rgba(31, 38, 135, 0.25);
    --shadow-strong: 0 16px 48px rgba(31, 38, 135, 0.35);
}

/* é¡µé¢æ•´ä½“èƒŒæ™¯ */
body {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
}

/* Hero Section - é¡¶éƒ¨æ¸å˜åŒºåŸŸ */
.hero-section {
    background: var(--primary-gradient);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
    padding: 2rem 0 3rem;
    margin: -1.5rem -15px 2rem;
    position: relative;
    overflow: hidden;
}

.hero-section::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 20%, transparent 70%);
    animation: floatBubble 20s ease-in-out infinite;
}

@keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

@keyframes floatBubble {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    33% { transform: translateY(-20px) rotate(2deg); }
    66% { transform: translateY(10px) rotate(-1deg); }
}

/* Hero Title Styling */
.hero-title {
    font-size: 3.5rem;
    font-weight: 800;
    color: white;
    text-shadow: 2px 4px 20px rgba(0,0,0,0.3);
    margin-bottom: 1rem;
    position: relative;
    z-index: 2;
}

.hero-icon {
    background: rgba(255,255,255,0.2);
    padding: 0.5rem;
    border-radius: 50%;
    backdrop-filter: blur(10px);
    animation: iconPulse 3s ease-in-out infinite;
}

@keyframes iconPulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255,255,255,0.3); }
    50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(255,255,255,0.5); }
}

.title-gradient {
    background: linear-gradient(45deg, #fff, #e0e8ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.hero-title-secondary {
    margin-top: 0.5rem;
}

.title-subtitle {
    font-size: 1.1rem;
    font-weight: 400;
    color: rgba(255,255,255,0.85);
    text-shadow: 1px 2px 8px rgba(0,0,0,0.2);
    letter-spacing: 1px;
}

.hero-subtitle {
    font-size: 1.25rem;
    color: rgba(255,255,255,0.9);
    text-shadow: 1px 2px 10px rgba(0,0,0,0.2);
    position: relative;
    z-index: 2;
}

/* Main Content */
.main-content {
    position: relative;
    z-index: 1;
    margin-top: -2rem;
}

/* ç°ä»£åŒ–è®¾ç½®å¡ç‰‡ */
.modern-settings-card {
    background: white;
    border-radius: 20px;
    box-shadow: var(--shadow-light);
    border: 1px solid rgba(255,255,255,0.3);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    margin-bottom: 2rem;
}

.modern-settings-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    border-radius: 20px 20px 0 0;
    background: var(--primary-gradient);
}

.modern-settings-card:nth-child(2)::before {
    background: var(--success-gradient);
}

.modern-settings-card:nth-child(3)::before {
    background: var(--warning-gradient);
}

.modern-settings-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: var(--shadow-strong);
}

.settings-card-header {
    padding: 2rem 2rem 1rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.settings-icon-wrapper {
    position: relative;
    flex-shrink: 0;
}

.settings-icon-bg {
    position: absolute;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    opacity: 0.1;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--primary-gradient);
}

.modern-settings-card:nth-child(2) .settings-icon-bg {
    background: var(--success-gradient);
}

.modern-settings-card:nth-child(3) .settings-icon-bg {
    background: var(--warning-gradient);
}

.settings-icon {
    font-size: 2rem;
    position: relative;
    z-index: 1;
    color: #667eea;
    transition: all 0.3s ease;
}

.modern-settings-card:nth-child(2) .settings-icon {
    color: #4facfe;
}

.modern-settings-card:nth-child(3) .settings-icon {
    color: #fa709a;
}

.settings-content {
    flex: 1;
}

.settings-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.modern-settings-card:nth-child(2) .settings-title {
    background: var(--success-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.modern-settings-card:nth-child(3) .settings-title {
    background: var(--warning-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.settings-subtitle {
    color: #64748b;
    font-size: 0.9rem;
    margin: 0;
}

.settings-card-body {
    padding: 0 2rem 2rem;
}

/* ç°ä»£åŒ–æç¤ºæ¡† */
.modern-alert {
    border-radius: 15px;
    border: none;
    padding: 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    position: relative;
    overflow: hidden;
}

.modern-alert::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 4px;
}

.modern-alert-info {
    background: linear-gradient(135deg, rgba(168, 237, 234, 0.1) 0%, rgba(254, 214, 227, 0.1) 100%);
    border: 1px solid rgba(168, 237, 234, 0.3);
}

.modern-alert-info::before {
    background: var(--info-gradient);
}

.modern-alert-warning {
    background: linear-gradient(135deg, rgba(250, 112, 154, 0.1) 0%, rgba(254, 225, 64, 0.1) 100%);
    border: 1px solid rgba(250, 112, 154, 0.3);
}

.modern-alert-warning::before {
    background: var(--warning-gradient);
}

.modern-alert-success {
    background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%);
    border: 1px solid rgba(79, 172, 254, 0.3);
}

.modern-alert-success::before {
    background: var(--success-gradient);
}

.alert-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.modern-alert-info .alert-icon {
    background: var(--info-gradient);
    color: white;
}

.modern-alert-warning .alert-icon {
    background: var(--warning-gradient);
    color: white;
}

.modern-alert-success .alert-icon {
    background: var(--success-gradient);
    color: white;
}

.alert-content {
    flex: 1;
}

.alert-title {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
    color: #1e293b;
}

.alert-text {
    color: #64748b;
    font-size: 0.875rem;
    line-height: 1.5;
    margin: 0;
}

/* ç°ä»£åŒ–è¡¨å•å…ƒç´  */
.form-label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.75rem;
    font-size: 0.9rem;
}

.form-select, .form-control {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    background: white;
}

.form-select:focus, .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

.form-help {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 0.5rem;
    line-height: 1.4;
}

/* ç°ä»£åŒ–æ»‘å— */
.slider-container {
    padding: 1rem 0;
    background: rgba(255,255,255,0.5);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid rgba(102, 126, 234, 0.1);
}

.form-range {
    height: 8px;
    background: linear-gradient(90deg, #e5e7eb 0%, #d1d5db 100%);
    border-radius: 4px;
    outline: none;
    border: none;
    appearance: none;
}

/* WebKit browsers (Chrome, Safari, newer Edge) */
.form-range::-webkit-slider-track {
    height: 8px;
    background: linear-gradient(90deg, #e5e7eb 0%, #d1d5db 100%);
    border-radius: 4px;
    border: none;
}

.form-range::-webkit-slider-thumb {
    appearance: none;
    height: 24px;
    width: 24px;
    border-radius: 50%;
    background: var(--primary-gradient);
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    transition: all 0.3s ease;
    border: 2px solid white;
    margin-top: -8px;
}

.form-range::-webkit-slider-thumb:hover {
    transform: scale(1.15);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

/* Firefox */
.form-range::-moz-range-track {
    height: 8px;
    background: linear-gradient(90deg, #e5e7eb 0%, #d1d5db 100%);
    border-radius: 4px;
    border: none;
}

.form-range::-moz-range-thumb {
    height: 24px;
    width: 24px;
    border-radius: 50%;
    background: var(--primary-gradient);
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.range-value {
    font-weight: 700;
    color: #667eea;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* ç°ä»£åŒ–å¼€å…³ */
.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
}

.form-check-input:focus {
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
}

.form-check-label {
    font-weight: 600;
    color: #374151;
}

/* ç°ä»£åŒ–æŒ‰é’® */
.modern-action-btn {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
    font-weight: 500;
    text-decoration: none;
    color: #374151;
    min-width: 160px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.save-btn {
    background: var(--success-gradient) !important;
    border: 2px solid transparent !important;
    color: white !important;
    box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4) !important;
}

.save-btn .btn-title,
.save-btn .btn-subtitle {
    color: white !important;
}

.save-btn:hover {
    transform: translateY(-3px) !important;
    box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6) !important;
    color: white !important;
}

.reset-btn {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
    border: 2px solid #dee2e6 !important;
    color: #495057 !important;
}

.reset-btn .btn-title,
.reset-btn .btn-subtitle {
    color: #495057 !important;
}

.reset-btn:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%) !important;
    border-color: #adb5bd !important;
    transform: translateY(-2px) !important;
    box-shadow: var(--shadow-light) !important;
    color: #495057 !important;
}

.reset-btn:hover .btn-title,
.reset-btn:hover .btn-subtitle {
    color: #495057 !important;
}

.btn-icon-wrapper {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.05);
    flex-shrink: 0;
}

.save-btn .btn-icon-wrapper {
    background: rgba(255,255,255,0.3) !important;
}

.reset-btn .btn-icon-wrapper {
    background: rgba(0,0,0,0.08) !important;
}

.reset-btn .btn-icon {
    color: #495057 !important;
}

.btn-icon {
    font-size: 1.2rem;
    color: inherit;
}

.btn-content {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    flex: 1;
}

.btn-title {
    font-weight: 600;
    font-size: 0.95rem;
    line-height: 1;
}

.btn-subtitle {
    font-size: 0.75rem;
    opacity: 0.8;
    margin-top: 0.1rem;
}

/* åŠ è½½çŠ¶æ€ */
.modern-action-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none !important;
}

/* æ—‹è½¬åŠ¨ç”» */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .hero-title {
        font-size: 2.5rem;
    }
    
    .settings-card-header {
        padding: 1.5rem;
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .settings-card-body {
        padding: 0 1.5rem 1.5rem;
    }
    
    .modern-action-btn {
        min-width: 140px;
        padding: 0.875rem 1.25rem;
    }
    
    .d-flex.gap-3 {
        flex-direction: column;
        gap: 1rem !important;
    }
}

@media (max-width: 576px) {
    .hero-section {
        margin-left: -15px;
        margin-right: -15px;
    }
    
    .hero-title {
        font-size: 2rem;
    }
    
    .title-subtitle {
        display: block;
        margin-left: 0;
        margin-top: 0.5rem;
        font-size: 1rem;
    }
    
    .modern-settings-card {
        margin-left: -15px;
        margin-right: -15px;
        border-radius: 15px;
    }
}
</style>

<script>
$(document).ready(function() {
    // æ»‘å—å€¼æ›´æ–°
    $('#relevance_threshold').on('input', function() {
        $('#relevance_value').text($(this).val());
    });

    $('#deep_analysis_threshold').on('input', function() {
        $('#deep_analysis_value').text($(this).val());
    });

    // æ·±åº¦åˆ†æå¼€å…³
    $('#enable_deep_analysis').change(function() {
        if ($(this).is(':checked')) {
            $('#deep_analysis_options').show();
        } else {
            $('#deep_analysis_options').hide();
        }
    });

    // è¿œç¨‹OCRå¼€å…³
    $('#enable_remote_ocr').change(function() {
        if ($(this).is(':checked')) {
            $('#remote_ocr_options').show();
        } else {
            $('#remote_ocr_options').hide();
        }
    });

    // é«˜çº§æ¨¡å‹é…ç½®å¼€å…³
    $('#enable_advanced_models').change(function() {
        if ($(this).is(':checked')) {
            $('#advanced_models_section').show();
        } else {
            $('#advanced_models_section').hide();
            // æ¸…ç©ºé«˜çº§é…ç½®é€‰æ‹©
            $('#abstract_analysis_model, #full_paper_analysis_model, #deep_analysis_model, #vision_model, #video_analysis_model').val('');
        }
    });

    // è¡¨å•æäº¤
    $('#settingsForm').submit(function(e) {
        e.preventDefault();
        saveSettings();
    });

    // æ¨¡æ€æ¡†ç„¦ç‚¹ç®¡ç†ï¼Œä¿®å¤å¯è®¿é—®æ€§é—®é¢˜
    let modalTriggerElement = null;
    
    $('#resultModal').on('show.bs.modal', function (e) {
        // ä¿å­˜è§¦å‘æ¨¡æ€æ¡†çš„å…ƒç´ 
        modalTriggerElement = document.activeElement;
    });

    $('#resultModal').on('hide.bs.modal', function (e) {
        // åœ¨æ¨¡æ€æ¡†éšè—å‰ï¼Œå°†ç„¦ç‚¹ä»æ¨¡æ€æ¡†å†…çš„å…ƒç´ ç§»å¼€
        $(this).find('button, [tabindex]').blur();
    });

    $('#resultModal').on('hidden.bs.modal', function (e) {
        // æ¨¡æ€æ¡†å®Œå…¨éšè—åï¼Œå°†ç„¦ç‚¹è¿”å›åˆ°è§¦å‘å…ƒç´ 
        if (modalTriggerElement && modalTriggerElement.focus) {
            modalTriggerElement.focus();
        }
        modalTriggerElement = null;
    });

    // åŠ è½½å¯ç”¨æ¨¡å‹åˆ—è¡¨ï¼ˆå¦‚æœæ¨¡æ¿ä¸­æ²¡æœ‰åŠ è½½ï¼‰
    if ($('#llm_model_name option').length <= 1) {
        loadAvailableModels();
    }
    
    // åŠ è½½ç°æœ‰é…ç½®
    loadSettings();

    // åˆå§‹åŒ–AOSåŠ¨ç”»
    AOS.init({
        duration: 800,
        easing: 'ease-in-out-cubic',
        once: true,
        offset: 100,
        delay: 100
    });
});

function loadAvailableModels() {
    $.ajax({
        url: '/api/models',
        method: 'GET',
        success: function(response) {
            if (response.success && response.data) {
                const modelSelects = [
                    '#llm_model_name',
                    '#abstract_analysis_model', 
                    '#full_paper_analysis_model',
                    '#deep_analysis_model',
                    '#vision_model',
                    '#video_analysis_model'
                ];
                
                modelSelects.forEach(function(selectId) {
                    const select = $(selectId);
                    const currentValue = select.val();
                    
                    // ä¿ç•™ç°æœ‰é€‰é¡¹çš„ç¬¬ä¸€ä¸ªï¼ˆé»˜è®¤é€‰é¡¹ï¼‰
                    const firstOption = select.find('option').first();
                    select.empty().append(firstOption);
                    
                    // æ·»åŠ æ¨¡å‹é€‰é¡¹
                    response.data.forEach(function(model) {
                        const option = $('<option></option>');
                        option.val(model).text(model);
                        if (model === currentValue) {
                            option.prop('selected', true);
                        }
                        select.append(option);
                    });
                });
            }
        },
        error: function() {
            showResult('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥', false);
        }
    });
}

function saveSettings() {
    const formData = getSettingsData();
    
    $('#saveBtn').prop('disabled', true);
    $('#saveBtn .btn-icon').removeClass('bi-check-lg').addClass('bi-arrow-clockwise');
    $('#saveBtn .btn-icon').css('animation', 'spin 1s linear infinite');
    $('#saveBtn .btn-title').text('ä¿å­˜ä¸­...');
    $('#saveBtn .btn-subtitle').text('Saving...');
    
    $.ajax({
        url: '/api/settings/save',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                showResult('è®¾ç½®ä¿å­˜æˆåŠŸï¼', true);
            } else {
                showResult('è®¾ç½®ä¿å­˜å¤±è´¥: ' + response.error, false);
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {error: 'è¯·æ±‚å¤±è´¥'};
            showResult('è®¾ç½®ä¿å­˜å¤±è´¥: ' + response.error, false);
        },
        complete: function() {
            $('#saveBtn').prop('disabled', false);
            $('#saveBtn .btn-icon').removeClass('bi-arrow-clockwise').addClass('bi-check-lg');
            $('#saveBtn .btn-icon').css('animation', '');
            $('#saveBtn .btn-title').text('ä¿å­˜è®¾ç½®');
            $('#saveBtn .btn-subtitle').text('Save');
        }
    });
}

function getSettingsData() {
    const formData = {};
    const form = document.getElementById('settingsForm');
    const formDataObj = new FormData(form);
    
    for (let [key, value] of formDataObj.entries()) {
        if (key.includes('threshold')) {
            formData[key] = parseFloat(value);
        } else if (key.includes('char_limit') || key.includes('timeout')) {
            formData[key] = parseInt(value);
        } else {
            formData[key] = value;
        }
    }
    
    // å¤„ç†å¤é€‰æ¡†
    formData['enable_deep_analysis'] = $('#enable_deep_analysis').is(':checked');
    formData['enable_video_analysis'] = $('#enable_video_analysis').is(':checked');
    formData['enable_remote_ocr'] = $('#enable_remote_ocr').is(':checked');
    
    // å¤„ç†é«˜çº§æ¨¡å‹é…ç½® - ç©ºå€¼è½¬æ¢ä¸ºnull
    const advancedModelFields = ['abstract_analysis_model', 'full_paper_analysis_model', 
                                'deep_analysis_model', 'vision_model', 'video_analysis_model'];
    for (const field of advancedModelFields) {
        if (!formData[field] || formData[field] === '') {
            formData[field] = null;
        }
    }
    
    return formData;
}

function resetSettings() {
    if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿ')) {
        // é‡ç½®è¡¨å•
        document.getElementById('settingsForm').reset();
        
        // é‡ç½®æ»‘å—æ˜¾ç¤º
        $('#relevance_value').text($('#relevance_threshold').val());
        $('#deep_analysis_value').text($('#deep_analysis_threshold').val());
        
        // é‡ç½®é«˜çº§æ¨¡å‹é…ç½®æ˜¾ç¤ºçŠ¶æ€
        $('#enable_advanced_models').prop('checked', false);
        $('#advanced_models_section').hide();
        
        // é‡ç½®æ·±åº¦åˆ†æé€‰é¡¹æ˜¾ç¤º
        if (!$('#enable_deep_analysis').is(':checked')) {
            $('#deep_analysis_options').hide();
        } else {
            $('#deep_analysis_options').show();
        }
    }
}

function loadSettings() {
    $.ajax({
        url: '/api/settings/load',
        method: 'GET',
        success: function(response) {
            if (response.success && response.config && Object.keys(response.config).length > 0) {
                const config = response.config;
                
                // å¡«å……LLMé…ç½®
                if (config.llm_model_name) {
                    $('#llm_model_name').val(config.llm_model_name);
                }
                if (config.relevance_threshold !== undefined) {
                    $('#relevance_threshold').val(config.relevance_threshold);
                    $('#relevance_value').text(config.relevance_threshold);
                }
                
                // å¡«å……é«˜çº§æ¨¡å‹é…ç½®
                if (config.abstract_analysis_model || config.full_paper_analysis_model || 
                    config.deep_analysis_model || config.vision_model || config.video_analysis_model) {
                    $('#enable_advanced_models').prop('checked', true);
                    $('#advanced_models_section').show();
                    
                    if (config.abstract_analysis_model) {
                        $('#abstract_analysis_model').val(config.abstract_analysis_model);
                    }
                    if (config.full_paper_analysis_model) {
                        $('#full_paper_analysis_model').val(config.full_paper_analysis_model);
                    }
                    if (config.deep_analysis_model) {
                        $('#deep_analysis_model').val(config.deep_analysis_model);
                    }
                    if (config.vision_model) {
                        $('#vision_model').val(config.vision_model);
                    }
                    if (config.video_analysis_model) {
                        $('#video_analysis_model').val(config.video_analysis_model);
                    }
                }
                
                // å¡«å……æ·±åº¦åˆ†æé…ç½®
                if (config.enable_deep_analysis !== undefined) {
                    $('#enable_deep_analysis').prop('checked', config.enable_deep_analysis);
                    if (config.enable_deep_analysis) {
                        $('#deep_analysis_options').show();
                    } else {
                        $('#deep_analysis_options').hide();
                    }
                }
                if (config.deep_analysis_threshold !== undefined) {
                    $('#deep_analysis_threshold').val(config.deep_analysis_threshold);
                    $('#deep_analysis_value').text(config.deep_analysis_threshold);
                }
                if (config.ocr_char_limit_for_analysis !== undefined) {
                    $('#ocr_char_limit_for_analysis').val(config.ocr_char_limit_for_analysis);
                }
                if (config.analysis_timeout !== undefined) {
                    $('#analysis_timeout').val(config.analysis_timeout);
                }
                if (config.enable_video_analysis !== undefined) {
                    $('#enable_video_analysis').prop('checked', config.enable_video_analysis);
                }
                
                // å¡«å……è¿œç¨‹OCRé…ç½®
                if (config.enable_remote_ocr !== undefined) {
                    $('#enable_remote_ocr').prop('checked', config.enable_remote_ocr);
                    if (config.enable_remote_ocr) {
                        $('#remote_ocr_options').show();
                    } else {
                        $('#remote_ocr_options').hide();
                    }
                }
                if (config.remote_ocr_endpoint !== undefined) {
                    $('#remote_ocr_endpoint').val(config.remote_ocr_endpoint);
                }
                if (config.remote_ocr_timeout !== undefined) {
                    $('#remote_ocr_timeout').val(config.remote_ocr_timeout);
                }
                if (config.remote_ocr_max_pages !== undefined) {
                    $('#remote_ocr_max_pages').val(config.remote_ocr_max_pages);
                }
                
                console.log('è®¾ç½®åŠ è½½æˆåŠŸ:', config);
            }
        },
        error: function(xhr) {
            console.warn('åŠ è½½è®¾ç½®å¤±è´¥:', xhr.responseJSON || xhr.statusText);
        }
    });
}

function showResult(message, success) {
    const alertClass = success ? 'alert-success' : 'alert-danger';
    const iconClass = success ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
    
    const html = `
        <div class="alert ${alertClass}">
            <i class="${iconClass} me-2"></i>${message}
        </div>
    `;
    
    $('#resultContent').html(html);
    $('#resultModal').modal('show');
}
</script>
{% endblock %}