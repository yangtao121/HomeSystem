{% extends "base.html" %}

{% block title %}任务状态 - {{ task_id }} - PaperGather{% endblock %}

{% block head %}
<style>
.progress-container {
    margin: 20px 0;
}

.status-badge {
    font-size: 1.2em;
    padding: 8px 16px;
}

.task-info-card {
    margin-bottom: 20px;
}

.log-container {
    max-height: 400px;
    overflow-y: auto;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
    font-family: monospace;
}

.refresh-indicator {
    display: none;
    color: #28a745;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-tasks me-2"></i>任务状态</h1>
                <p class="text-muted mb-0">任务ID: <code>{{ task_id }}</code></p>
            </div>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="refreshStatus()">
                    <i class="fas fa-sync-alt me-1" id="refreshIcon"></i>刷新
                </button>
                {% if task_result.status in ['pending', 'running'] %}
                <button class="btn btn-outline-danger" onclick="cancelTask()">
                    <i class="fas fa-stop me-1"></i>取消任务
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 任务基本信息 -->
    <div class="col-lg-8 mb-4">
        <div class="card task-info-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>任务信息
                </h5>
                <span class="refresh-indicator">
                    <i class="fas fa-circle text-success"></i> 自动刷新中
                </span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>任务状态:</strong></td>
                                <td>
                                    <span class="badge bg-{{ task_result.status | status_badge }} status-badge" id="taskStatus">
                                        {{ task_result.status | upper }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>开始时间:</strong></td>
                                <td id="startTime">{{ task_result.start_time | format_date }}</td>
                            </tr>
                            <tr>
                                <td><strong>结束时间:</strong></td>
                                <td id="endTime">
                                    {% if task_result.end_time %}
                                        {{ task_result.end_time | format_date }}
                                    {% else %}
                                        <span class="text-muted">运行中...</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>执行时间:</strong></td>
                                <td id="duration">
                                    {% if task_result.duration %}
                                        {{ task_result.duration | format_duration }}
                                    {% else %}
                                        <span class="text-muted">计算中...</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <!-- 进度条 -->
                        <div class="progress-container">
                            <label class="form-label">执行进度</label>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: {{ (task_result.progress * 100) | round(1) }}%"
                                     id="progressBar">
                                    <span id="progressText">{{ (task_result.progress * 100) | round(1) }}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 错误信息 -->
                        {% if task_result.error_message %}
                        <div class="alert alert-danger mt-3">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>错误信息</h6>
                            <p class="mb-0" id="errorMessage">{{ task_result.error_message }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 任务结果 -->
        {% if task_result.status == 'completed' and task_result.result_data %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>执行结果
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="border-end">
                            <h4 class="text-primary">{{ task_result.result_data.total_papers | default(0) }}</h4>
                            <p class="text-muted mb-0">搜索到论文</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="border-end">
                            <h4 class="text-success">{{ task_result.result_data.relevant_papers | default(0) }}</h4>
                            <p class="text-muted mb-0">相关论文</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="border-end">
                            <h4 class="text-info">{{ task_result.result_data.analyzed_papers | default(0) }}</h4>
                            <p class="text-muted mb-0">已分析论文</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4 class="text-warning">{{ task_result.result_data.saved_papers | default(0) }}</h4>
                        <p class="text-muted mb-0">已保存论文</p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <a href="{{ url_for('collect.task_results', task_id=task_id) }}" class="btn btn-primary">
                        <i class="fas fa-eye me-1"></i>查看详细结果
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- 侧边栏 -->
    <div class="col-lg-4">
        <!-- 快速操作 -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>快速操作
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if task_result.status == 'completed' %}
                    <a href="{{ url_for('collect.task_results', task_id=task_id) }}" class="btn btn-primary">
                        <i class="fas fa-eye me-1"></i>查看结果
                    </a>
                    {% endif %}
                    
                    <a href="{{ url_for('collect.config') }}" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-1"></i>新建任务
                    </a>
                    
                    <a href="{{ url_for('collect.task_history') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-history me-1"></i>执行历史
                    </a>
                    
                    {% if task_result.status in ['pending', 'running'] %}
                    <button class="btn btn-outline-danger" onclick="cancelTask()">
                        <i class="fas fa-stop me-1"></i>取消任务
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 任务统计 -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>实时统计
                </h6>
            </div>
            <div class="card-body">
                <div id="taskStats">
                    {% if task_result.result_data %}
                    <div class="row">
                        <div class="col-6 text-center mb-3">
                            <h5 class="text-primary mb-1" id="totalPapers">{{ task_result.result_data.total_papers | default(0) }}</h5>
                            <small class="text-muted">搜索到</small>
                        </div>
                        <div class="col-6 text-center mb-3">
                            <h5 class="text-success mb-1" id="relevantPapers">{{ task_result.result_data.relevant_papers | default(0) }}</h5>
                            <small class="text-muted">相关</small>
                        </div>
                        <div class="col-6 text-center mb-3">
                            <h5 class="text-info mb-1" id="analyzedPapers">{{ task_result.result_data.analyzed_papers | default(0) }}</h5>
                            <small class="text-muted">已分析</small>
                        </div>
                        <div class="col-6 text-center mb-3">
                            <h5 class="text-warning mb-1" id="savedPapers">{{ task_result.result_data.saved_papers | default(0) }}</h5>
                            <small class="text-muted">已保存</small>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">等待任务结果...</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefresh = false;
let refreshInterval;

$(document).ready(function() {
    const status = '{{ task_result.status }}';
    
    // 如果任务正在运行，启动自动刷新
    if (status === 'pending' || status === 'running') {
        startAutoRefresh();
    }
});

function startAutoRefresh() {
    autoRefresh = true;
    $('.refresh-indicator').show();
    
    refreshInterval = setInterval(function() {
        refreshStatus(false); // 静默刷新
    }, 3000); // 每3秒刷新
}

function stopAutoRefresh() {
    autoRefresh = false;
    $('.refresh-indicator').hide();
    
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
}

function refreshStatus(showIndicator = true) {
    if (showIndicator) {
        $('#refreshIcon').addClass('fa-spin');
    }
    
    $.get('/api/task/status/{{ task_id }}', function(response) {
        if (response.success) {
            updateTaskStatus(response.data);
            
            // 如果任务完成，停止自动刷新
            if (response.data.status === 'completed' || 
                response.data.status === 'failed' || 
                response.data.status === 'stopped') {
                stopAutoRefresh();
                
                // 显示完成通知
                if (response.data.status === 'completed') {
                    showNotification('任务执行完成！', 'success');
                }
            }
        }
    }).always(function() {
        if (showIndicator) {
            $('#refreshIcon').removeClass('fa-spin');
        }
    });
}

function updateTaskStatus(data) {
    // 更新状态徽章
    const statusBadge = $('#taskStatus');
    statusBadge.removeClass().addClass('badge status-badge bg-' + getStatusBadgeClass(data.status));
    statusBadge.text(data.status.toUpperCase());
    
    // 更新时间
    if (data.end_time) {
        $('#endTime').text(formatDate(data.end_time));
    }
    
    if (data.duration) {
        $('#duration').text(formatDuration(data.duration));
    }
    
    // 更新进度条
    const progress = (data.progress * 100).toFixed(1);
    $('#progressBar').css('width', progress + '%');
    $('#progressText').text(progress + '%');
    
    // 更新错误信息
    if (data.error_message) {
        if ($('#errorMessage').length === 0) {
            $('.task-info-card .card-body').append(`
                <div class="alert alert-danger mt-3">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>错误信息</h6>
                    <p class="mb-0" id="errorMessage">${data.error_message}</p>
                </div>
            `);
        } else {
            $('#errorMessage').text(data.error_message);
        }
    }
    
    // 更新统计数据
    if (data.result_data) {
        $('#totalPapers').text(data.result_data.total_papers || 0);
        $('#relevantPapers').text(data.result_data.relevant_papers || 0);
        $('#analyzedPapers').text(data.result_data.analyzed_papers || 0);
        $('#savedPapers').text(data.result_data.saved_papers || 0);
    }
}

function cancelTask() {
    if (!confirm('确定要取消当前任务吗？')) {
        return;
    }
    
    $.post('/task/cancel/{{ task_id }}', function(response) {
        if (response.success) {
            showNotification('任务已取消', 'warning');
            setTimeout(function() {
                refreshStatus();
            }, 1000);
        } else {
            showNotification('取消任务失败: ' + response.error, 'danger');
        }
    });
}

function getStatusBadgeClass(status) {
    const statusMap = {
        'pending': 'warning',
        'running': 'info',
        'completed': 'success',
        'failed': 'danger',
        'stopped': 'secondary'
    };
    return statusMap[status] || 'secondary';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN');
}

function formatDuration(seconds) {
    if (seconds < 60) {
        return seconds.toFixed(1) + '秒';
    } else if (seconds < 3600) {
        return (seconds / 60).toFixed(1) + '分钟';
    } else {
        return (seconds / 3600).toFixed(1) + '小时';
    }
}

function showNotification(message, type) {
    const alert = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('main .container-fluid').prepend(alert);
    
    // 自动隐藏
    setTimeout(function() {
        $('.alert').alert('close');
    }, 5000);
}

// 页面卸载时停止自动刷新
$(window).on('beforeunload', function() {
    stopAutoRefresh();
});
</script>
{% endblock %}