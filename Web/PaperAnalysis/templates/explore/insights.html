{% extends "base.html" %}

{% block title %}ç ”ç©¶æ´å¯Ÿ - ArXivè®ºæ–‡æ•°æ®æ¢ç´¢{% endblock %}

{% block content %}
<!-- é¡µé¢æ ‡é¢˜ -->
<div class="row mb-4">
    <div class="col">
        <h1 class="display-6 mb-2">
            <i class="bi bi-lightbulb-fill"></i>
            ç ”ç©¶æ´å¯Ÿ
        </h1>
        <p class="text-muted">åŸºäºç»“æ„åŒ–åˆ†æçš„æ·±åº¦ç ”ç©¶è¶‹åŠ¿å’Œæ´å¯Ÿ</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-outline-primary" onclick="refreshData()">
            <i class="bi bi-arrow-clockwise"></i>
            åˆ·æ–°æ•°æ®
        </button>
    </div>
</div>

<!-- å…³é”®è¯åˆ†æ -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-cloud"></i>
                    çƒ­é—¨å…³é”®è¯åˆ†æ (Top 30)
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="keywordCloudChart"></canvas>
                </div>
                
                <!-- å…³é”®è¯æ ‡ç­¾äº‘ -->
                <div class="mt-3">
                    <h6>å…³é”®è¯æ ‡ç­¾äº‘</h6>
                    <div class="keyword-cloud">
                        {% for keyword in insights.keywords[:30] %}
                        {% set size = (keyword.frequency / insights.keywords[0].frequency * 100) if insights.keywords else 0 %}
                        <span class="keyword-tag" 
                              style="font-size: {{ (size / 100 * 1.5 + 0.8)|round(1) }}rem; opacity: {{ (size / 100 * 0.5 + 0.5)|round(1) }};"
                              onclick="searchKeyword('{{ keyword.keywords }}')">
                            {{ keyword.keywords }}
                            <small>({{ keyword.frequency }})</small>
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å…³é”®è¯ç»Ÿè®¡ -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-key-fill"></i>
                    å…³é”®è¯ç»Ÿè®¡
                </h5>
            </div>
            <div class="card-body">
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="stats-number text-primary">{{ insights.keywords|length }}</div>
                        <div class="stats-label">æ€»å…³é”®è¯æ•°</div>
                    </div>
                    <div class="col-6">
                        <div class="stats-number text-success">{{ insights.keywords[0].frequency if insights.keywords else 0 }}</div>
                        <div class="stats-label">æœ€é«˜é¢‘æ¬¡</div>
                    </div>
                </div>
                
                <!-- Top 10 å…³é”®è¯åˆ—è¡¨ -->
                <div class="keyword-list">
                    <h6>Top 10 å…³é”®è¯</h6>
                    {% for keyword in insights.keywords[:10] %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="keyword-item" onclick="searchKeyword('{{ keyword.keywords }}')">
                            {{ keyword.keywords|truncate(20) }}
                        </span>
                        <span class="badge bg-primary">{{ keyword.frequency }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç ”ç©¶æ–¹æ³•è¶‹åŠ¿ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear-fill"></i>
                    ç ”ç©¶æ–¹æ³•è¶‹åŠ¿åˆ†æ
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="methodTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <h6>çƒ­é—¨ç ”ç©¶æ–¹æ³•</h6>
                        <div class="method-list">
                            {% for method in insights.methods[:10] %}
                            <div class="method-item mb-2 p-2 border rounded">
                                <div class="fw-bold">{{ method.methods|truncate(50) }}</div>
                                <small class="text-muted">ä½¿ç”¨æ¬¡æ•°: {{ method.count }}</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é«˜è´¨é‡è®ºæ–‡æ¨è -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-star-fill"></i>
                    é«˜è´¨é‡è®ºæ–‡æ¨è
                    <small class="text-muted">ï¼ˆåŸºäºç»“æ„åŒ–åˆ†æå®Œæ•´æ€§æ’åºï¼‰</small>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="5%">æ’å</th>
                                <th width="40%">è®ºæ–‡æ ‡é¢˜</th>
                                <th width="25%">ä½œè€…</th>
                                <th width="15%">å®Œæ•´æ€§è¯„åˆ†</th>
                                <th width="15%">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for paper in insights.high_impact %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <a href="{{ url_for('explore.paper_detail', arxiv_id=paper.arxiv_id) }}" 
                                       class="text-decoration-none fw-bold">
                                        {{ paper.title|truncate(80) }}
                                    </a>
                                </td>
                                <td>
                                    <small class="text-muted">{{ paper.authors|truncate(50) }}</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 15px;">
                                            <div class="progress-bar bg-success" 
                                                 style="width: {{ (paper.completeness_score / 6 * 100)|int }}%">
                                                {{ paper.completeness_score }}/6
                                            </div>
                                        </div>
                                        <small>{{ "%.0f"|format(paper.completeness_score / 6 * 100) }}%</small>
                                    </div>
                                </td>
                                <td>
                                    <a href="{{ url_for('explore.paper_detail', arxiv_id=paper.arxiv_id) }}" 
                                       class="btn btn-sm btn-primary">
                                        æŸ¥çœ‹è¯¦æƒ…
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç ”ç©¶é¢†åŸŸæ´å¯Ÿ -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bullseye"></i>
                    ç ”ç©¶çƒ­ç‚¹å‘ç°
                </h5>
            </div>
            <div class="card-body">
                <div class="insight-item mb-3">
                    <h6 class="text-primary">ğŸ”¥ æœ€çƒ­é—¨ç ”ç©¶é¢†åŸŸ</h6>
                    <p>åŸºäºå…³é”®è¯é¢‘æ¬¡åˆ†æï¼Œå½“å‰æœ€å—å…³æ³¨çš„ç ”ç©¶é¢†åŸŸåŒ…æ‹¬ï¼š</p>
                    <ul>
                        {% for keyword in insights.keywords[:5] %}
                        <li><strong>{{ keyword.keywords }}</strong> ({{ keyword.frequency }} ç¯‡è®ºæ–‡)</li>
                        {% endfor %}
                    </ul>
                </div>
                
                <div class="insight-item mb-3">
                    <h6 class="text-success">ğŸ“ˆ æ–°å…´ç ”ç©¶æ–¹å‘</h6>
                    <p>ç»“æ„åŒ–åˆ†ææ˜¾ç¤ºï¼Œä»¥ä¸‹æ–¹æ³•è®ºæ­£åœ¨è·å¾—æ›´å¤šå…³æ³¨ï¼š</p>
                    <ul>
                        {% for method in insights.methods[:3] %}
                        <li>{{ method.methods|truncate(100) }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up-arrow"></i>
                    è´¨é‡è¶‹åŠ¿åˆ†æ
                </h5>
            </div>
            <div class="card-body">
                <div class="insight-item mb-3">
                    <h6 class="text-info">ğŸ“Š ç»“æ„åŒ–åˆ†æè¶‹åŠ¿</h6>
                    <p>è®ºæ–‡è´¨é‡æŒç»­æå‡ï¼Œç»“æ„åŒ–ä¿¡æ¯è¶Šæ¥è¶Šå®Œæ•´ï¼š</p>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="stats-number text-primary">{{ insights.high_impact|length }}</div>
                            <div class="stats-label">é«˜è´¨é‡è®ºæ–‡</div>
                        </div>
                        <div class="col-4">
                            {% set avg_score = (insights.high_impact|sum(attribute='completeness_score') / insights.high_impact|length) if insights.high_impact else 0 %}
                            <div class="stats-number text-success">{{ "%.1f"|format(avg_score) }}</div>
                            <div class="stats-label">å¹³å‡å®Œæ•´æ€§</div>
                        </div>
                        <div class="col-4">
                            <div class="stats-number text-warning">{{ (insights.high_impact|selectattr('completeness_score', '==', 6)|list|length) }}</div>
                            <div class="stats-label">å®Œç¾è®ºæ–‡</div>
                        </div>
                    </div>
                </div>
                
                <div class="insight-item">
                    <h6 class="text-warning">ğŸ’¡ æ”¹è¿›å»ºè®®</h6>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-check-circle text-success"></i> ç»§ç»­æå‡ç»“æ„åŒ–åˆ†æè¦†ç›–ç‡</li>
                        <li><i class="bi bi-check-circle text-success"></i> é‡ç‚¹å…³æ³¨é«˜é¢‘å…³é”®è¯é¢†åŸŸ</li>
                        <li><i class="bi bi-check-circle text-success"></i> åŠ å¼ºæ–°å…´æ–¹æ³•è®ºçš„è¿½è¸ª</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ•°æ®è„šæœ¬ -->
<script type="application/json" id="keywordData">
{
    "labels": [
        {% for keyword in insights.keywords[:15] %}
        "{{ keyword.keywords|truncate(15) }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    "data": [
        {% for keyword in insights.keywords[:15] %}
        {{ keyword.frequency }}{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>

<script type="application/json" id="methodData">
{
    "labels": [
        {% for method in insights.methods[:10] %}
        "{{ method.methods|truncate(20) }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    "data": [
        {% for method in insights.methods[:10] %}
        {{ method.count }}{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>

{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        createInsightCharts();
    });
    
    function createInsightCharts() {
        // å…³é”®è¯æŸ±çŠ¶å›¾
        const keywordCtx = document.getElementById('keywordCloudChart');
        if (keywordCtx) {
            const keywordData = JSON.parse(document.getElementById('keywordData').textContent);
            new Chart(keywordCtx, {
                type: 'bar',
                data: {
                    labels: keywordData.labels,
                    datasets: [{
                        label: 'å‡ºç°é¢‘æ¬¡',
                        data: keywordData.data,
                        backgroundColor: 'rgba(52, 152, 219, 0.8)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        // ç ”ç©¶æ–¹æ³•å›¾
        const methodCtx = document.getElementById('methodTrendChart');
        if (methodCtx) {
            const methodData = JSON.parse(document.getElementById('methodData').textContent);
            new Chart(methodCtx, {
                type: 'horizontalBar',
                data: {
                    labels: methodData.labels,
                    datasets: [{
                        label: 'ä½¿ç”¨æ¬¡æ•°',
                        data: methodData.data,
                        backgroundColor: 'rgba(46, 204, 113, 0.8)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    }
    
    // æœç´¢å…³é”®è¯
    function searchKeyword(keyword) {
        window.location.href = `{{ url_for('explore.papers') }}?q=${encodeURIComponent(keyword)}`;
    }
    
    // å…³é”®è¯æ ‡ç­¾äº‘æ ·å¼
    document.addEventListener('DOMContentLoaded', function() {
        const keywordTags = document.querySelectorAll('.keyword-tag');
        keywordTags.forEach(tag => {
            tag.style.cursor = 'pointer';
            tag.style.margin = '3px';
            tag.style.padding = '2px 6px';
            tag.style.backgroundColor = '#e9ecef';
            tag.style.borderRadius = '12px';
            tag.style.display = 'inline-block';
            tag.style.transition = 'all 0.2s ease';
            
            tag.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#007bff';
                this.style.color = 'white';
                this.style.transform = 'scale(1.1)';
            });
            
            tag.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '#e9ecef';
                this.style.color = 'inherit';
                this.style.transform = 'scale(1)';
            });
        });
        
        // å…³é”®è¯åˆ—è¡¨é¡¹æ ·å¼
        const keywordItems = document.querySelectorAll('.keyword-item');
        keywordItems.forEach(item => {
            item.style.cursor = 'pointer';
            item.addEventListener('click', function() {
                this.style.color = '#007bff';
            });
        });
    });
</script>

<style>
.keyword-cloud {
    line-height: 2;
}

.keyword-tag {
    transition: all 0.2s ease;
}

.keyword-item:hover {
    color: #007bff !important;
    text-decoration: underline;
}

.method-item:hover {
    background-color: #f8f9fa !important;
    border-color: #007bff !important;
}

.insight-item {
    border-left: 3px solid #dee2e6;
    padding-left: 1rem;
}
</style>
{% endblock %}