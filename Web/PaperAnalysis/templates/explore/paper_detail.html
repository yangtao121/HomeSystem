{% extends "base.html" %}

{% block title %}{{ paper.title }} - ArXivè®ºæ–‡è¯¦æƒ…{% endblock %}

{% block content %}
<!-- å¯¼èˆªæŒ‰é’®ç»„ -->
<div class="row mb-3">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center">
            <!-- å·¦ä¾§ï¼šè¿”å›æŒ‰é’® -->
            <a href="{{ url_for('explore.papers') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> è¿”å›è®ºæ–‡åˆ—è¡¨
            </a>
            
            <!-- ä¸­é—´ï¼šè®ºæ–‡å¯¼èˆªæŒ‰é’® -->
            <div class="btn-group" role="group" aria-label="è®ºæ–‡å¯¼èˆª">
                {% if navigation.previous %}
                <a href="{{ url_for('explore.paper_detail', arxiv_id=navigation.previous.arxiv_id) }}" 
                   class="btn btn-outline-primary" id="prev-paper-btn"
                   title="{{ navigation.previous.title | truncate_text(50) }}">
                    <i class="bi bi-chevron-left"></i> ä¸Šä¸€ç¯‡
                </a>
                {% else %}
                <button class="btn btn-outline-secondary" disabled title="å·²æ˜¯ç¬¬ä¸€ç¯‡è®ºæ–‡">
                    <i class="bi bi-chevron-left"></i> ä¸Šä¸€ç¯‡
                </button>
                {% endif %}
                
                {% if navigation.next %}
                <a href="{{ url_for('explore.paper_detail', arxiv_id=navigation.next.arxiv_id) }}" 
                   class="btn btn-outline-primary" id="next-paper-btn"
                   title="{{ navigation.next.title | truncate_text(50) }}">
                    ä¸‹ä¸€ç¯‡ <i class="bi bi-chevron-right"></i>
                </a>
                {% else %}
                <button class="btn btn-outline-secondary" disabled title="å·²æ˜¯æœ€åä¸€ç¯‡è®ºæ–‡">
                    ä¸‹ä¸€ç¯‡ <i class="bi bi-chevron-right"></i>
                </button>
                {% endif %}
            </div>
            
            <!-- å³ä¾§ï¼šå¿«æ·é”®æç¤º -->
            <small class="text-muted d-none d-md-block">
                <i class="bi bi-keyboard"></i> 
                ä½¿ç”¨ â† â†’ é”®å¯¼èˆª
            </small>
        </div>
    </div>
</div>

<!-- è®ºæ–‡è¯¦æƒ…å¡ç‰‡ -->
<div class="paper-detail">
    <!-- è®ºæ–‡æ ‡é¢˜å’ŒåŸºæœ¬ä¿¡æ¯ -->
    <div class="detail-section">
        <div class="row align-items-start">
            <div class="col-md-9">
                <h1 class="h2 mb-4 text-dark">{{ paper.title }}</h1>
                
                <!-- åŸºæœ¬ä¿¡æ¯é‡æ–°è®¾è®¡ -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="info-item mb-3">
                            <span class="info-label">
                                <i class="bi bi-file-text text-primary"></i> ArXiv ID
                            </span>
                            <div class="info-value">
                                <code class="text-primary fw-bold">{{ paper.arxiv_id }}</code>
                                <button class="btn btn-sm btn-outline-secondary ms-2" 
                                        onclick="copyToClipboard('{{ paper.arxiv_id }}')" title="å¤åˆ¶ID">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-calendar3 text-primary"></i> å‘å¸ƒæ—¶é—´
                            </span>
                            <div class="info-value text-muted">{{ paper.published_date or 'æœªçŸ¥' }}</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="info-item mb-3">
                            <span class="info-label">
                                <i class="bi bi-tags text-primary"></i> åˆ†ç±»
                            </span>
                            <div class="info-value">
                                {% for category in paper.categories.split(',') %}
                                <span class="badge bg-light text-dark border me-1 mb-1">{{ category | safe_strip }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        {% if paper.full_paper_relevance_score is not none %}
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-star text-warning"></i> ç›¸å…³åº¦è¯„åˆ†
                            </span>
                            <div class="info-value">
                                <div class="relevance-score-display d-flex align-items-center mb-2">
                                    <div class="score-stars me-2">
                                        {{ paper.full_paper_relevance_score|relevance_score_stars|safe }}
                                    </div>
                                    <div class="score-badge">
                                        {% set score = paper.full_paper_relevance_score | float %}
                                        {% if score >= 0.8 %}
                                            <span class="badge bg-success">é«˜ç›¸å…³ ({{ "%.2f" | format(score) }})</span>
                                        {% elif score >= 0.6 %}
                                            <span class="badge bg-warning text-dark">ä¸­ç›¸å…³ ({{ "%.2f" | format(score) }})</span>
                                        {% elif score >= 0.4 %}
                                            <span class="badge bg-info">ä¸€èˆ¬ ({{ "%.2f" | format(score) }})</span>
                                        {% elif score >= 0.2 %}
                                            <span class="badge bg-secondary">ä½ç›¸å…³ ({{ "%.2f" | format(score) }})</span>
                                        {% else %}
                                            <span class="badge bg-danger">ä¸ç›¸å…³ ({{ "%.2f" | format(score) }})</span>
                                        {% endif %}
                                    </div>
                                    {% if paper.full_paper_relevance_justification %}
                                    <button class="btn btn-sm btn-outline-info ms-2" 
                                            type="button"
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#relevanceJustification" 
                                            aria-expanded="false" 
                                            aria-controls="relevanceJustification"
                                            title="æŸ¥çœ‹è¯„åˆ†ç†ç”±">
                                        <i class="bi bi-info-circle"></i> è¯„åˆ†è¯¦æƒ…
                                    </button>
                                    {% endif %}
                                </div>
                                <!-- å¯æŠ˜å çš„è¯„åˆ†ç†ç”± -->
                                {% if paper.full_paper_relevance_justification %}
                                <div class="collapse" id="relevanceJustification">
                                    <div class="relevance-justification-content mt-2">
                                        <div class="small text-muted mb-2">
                                            <i class="bi bi-chat-text"></i> è¯„åˆ†ç†ç”±
                                        </div>
                                        <div class="markdown-content small border-start border-info ps-3">
                                            {{ paper.full_paper_relevance_justification|markdown|safe }}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <!-- æ“ä½œæŒ‰é’®é‡æ–°è®¾è®¡ -->
                <div class="action-buttons-container">
                    <!-- ä¸»è¦æ“ä½œ -->
                    <div class="primary-actions mb-3">
                        {% if paper.pdf_url %}
                        <a href="{{ paper.pdf_url }}" target="_blank" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-file-pdf"></i> æŸ¥çœ‹PDF
                        </a>
                        {% endif %}
                        
                        <!-- æ·±åº¦åˆ†ææ“ä½œ -->
                        <div id="deep-analysis-section">
                            {% if paper.get('deep_analysis_status') %}
                                {% if paper.deep_analysis_status == 'completed' %}
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('explore.paper_analysis_view', arxiv_id=paper.arxiv_id) }}" class="btn btn-success w-100" target="_blank">
                                        <i class="bi bi-lightbulb-fill"></i> æŸ¥çœ‹æ·±åº¦åˆ†æ
                                        <span class="badge bg-light text-success ms-2">âœ“ å·²å®Œæˆ</span>
                                    </a>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="resetAnalysisStatus('{{ paper.arxiv_id }}')"> 
                                        <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®çŠ¶æ€
                                    </button>
                                </div>
                                
                                {% elif paper.deep_analysis_status == 'processing' %}
                                <div class="d-grid gap-2">
                                    <button class="btn btn-info w-100" disabled id="processing-btn-{{ paper.arxiv_id }}">
                                        <div class="spinner-border spinner-border-sm me-2" role="status">
                                            <span class="visually-hidden">åˆ†æä¸­...</span>
                                        </div>
                                        æ·±åº¦åˆ†æè¿›è¡Œä¸­...
                                        <div class="progress-indicator mt-1">
                                            <small class="text-light">é¢„è®¡è€—æ—¶: 15-30åˆ†é’Ÿ</small>
                                        </div>
                                    </button>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-warning btn-sm" onclick="cancelAnalysis('{{ paper.arxiv_id }}')">
                                            <i class="bi bi-x-circle"></i> å–æ¶ˆåˆ†æ
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="resetAnalysisStatus('{{ paper.arxiv_id }}')">
                                            <i class="bi bi-arrow-counterclockwise"></i> å¼ºåˆ¶é‡ç½®
                                        </button>
                                    </div>
                                </div>
                                
                                {% elif paper.deep_analysis_status == 'failed' %}
                                <div class="d-grid gap-2">
                                    <div class="alert alert-danger mb-2" role="alert">
                                        <i class="bi bi-exclamation-triangle"></i> åˆ†æå¤±è´¥
                                    </div>
                                    <button id="deep-analysis-btn-{{ paper.arxiv_id }}" class="btn btn-outline-primary w-100 start-deep-analysis" data-arxiv-id="{{ paper.arxiv_id }}">
                                        <i class="bi bi-arrow-repeat"></i> é‡è¯•æ·±åº¦åˆ†æ
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="resetAnalysisStatus('{{ paper.arxiv_id }}')">
                                        <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®çŠ¶æ€
                                    </button>
                                </div>
                                
                                {% elif paper.deep_analysis_status == 'cancelled' %}
                                <div class="d-grid gap-2">
                                    <div class="alert alert-warning mb-2" role="alert">
                                        <i class="bi bi-info-circle"></i> åˆ†æå·²å–æ¶ˆ
                                    </div>
                                    <button id="deep-analysis-btn-{{ paper.arxiv_id }}" class="btn btn-outline-primary w-100 start-deep-analysis" data-arxiv-id="{{ paper.arxiv_id }}">
                                        <i class="bi bi-lightbulb"></i> é‡æ–°å¼€å§‹åˆ†æ
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="resetAnalysisStatus('{{ paper.arxiv_id }}')">
                                        <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®çŠ¶æ€
                                    </button>
                                </div>
                                
                                {% elif paper.deep_analysis_status == 'pending' %}
                                <div class="d-grid gap-2">
                                    <div class="alert alert-info mb-2" role="alert">
                                        <i class="bi bi-clock"></i> å¾…å¤„ç†çŠ¶æ€
                                    </div>
                                    <button id="deep-analysis-btn-{{ paper.arxiv_id }}" class="btn btn-primary w-100 start-deep-analysis" data-arxiv-id="{{ paper.arxiv_id }}">
                                        <i class="bi bi-lightbulb"></i> å¼€å§‹æ·±åº¦åˆ†æ
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="resetAnalysisStatus('{{ paper.arxiv_id }}')">
                                        <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®çŠ¶æ€
                                    </button>
                                </div>
                                
                                {% else %}
                                <button id="deep-analysis-btn-{{ paper.arxiv_id }}" class="btn btn-outline-primary w-100 mb-2 start-deep-analysis" data-arxiv-id="{{ paper.arxiv_id }}">
                                    <i class="bi bi-lightbulb"></i> å¼€å§‹æ·±åº¦åˆ†æ
                                </button>
                                {% endif %}
                            {% else %}
                            <button id="deep-analysis-btn-{{ paper.arxiv_id }}" class="btn btn-outline-primary w-100 mb-2 start-deep-analysis" data-arxiv-id="{{ paper.arxiv_id }}">
                                <i class="bi bi-lightbulb"></i> å¼€å§‹æ·±åº¦åˆ†æ
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Dify çŸ¥è¯†åº“æ“ä½œ -->
                    <div class="knowledge-base-section mb-3">
                        <h6 class="text-muted small mb-2">
                            <i class="bi bi-cloud"></i> çŸ¥è¯†åº“
                        </h6>
                        <div id="dify-upload-section">
                            {% if paper.dify_document_id %}
                            <div class="alert alert-success small mb-2 py-2">
                                <i class="bi bi-cloud-check"></i> å·²ä¸Šä¼ åˆ°çŸ¥è¯†åº“
                            </div>
                            <div class="btn-group w-100 mb-2" role="group">
                                <button class="btn btn-outline-info btn-sm" onclick="verifyDifyDocument('{{ paper.arxiv_id }}')">
                                    <i class="bi bi-shield-check"></i> éªŒè¯
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="removePaperFromDify('{{ paper.arxiv_id }}')">
                                    <i class="bi bi-trash"></i> ç§»é™¤
                                </button>
                            </div>
                            {% else %}
                            <button class="btn btn-outline-success w-100 mb-2" onclick="uploadPaperToDify('{{ paper.arxiv_id }}')">
                                <i class="bi bi-cloud-upload"></i> ä¸Šä¼ åˆ°çŸ¥è¯†åº“
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- å…¶ä»–æ“ä½œ -->
                    <div class="other-actions">
                        <h6 class="text-muted small mb-2">
                            <i class="bi bi-gear"></i> å…¶ä»–æ“ä½œ
                        </h6>
                        <div class="btn-group w-100 mb-2" role="group">
                            <button class="btn btn-outline-warning btn-sm" onclick="openMigrationModal('{{ paper.arxiv_id }}', '{{ paper.title | e }}')">
                                <i class="bi bi-arrow-right-circle"></i> è¿ç§»
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="copyToClipboard(window.location.href)">
                                <i class="bi bi-share"></i> åˆ†äº«
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä½œè€…ä¿¡æ¯ -->
    {% if paper.authors %}
    <div class="detail-section">
        <div class="detail-label">ä½œè€…</div>
        <div class="detail-content">{{ paper.authors }}</div>
    </div>
    {% endif %}
    
    <!-- è®ºæ–‡æ‘˜è¦ -->
    {% if paper.abstract %}
    <div class="detail-section">
        <div class="detail-label">æ‘˜è¦</div>
        <div class="detail-content markdown-content">{{ paper.abstract|markdown|safe }}</div>
    </div>
    {% endif %}
    
    <!-- æ·±åº¦åˆ†æé¢„è§ˆ -->
    {% if paper.has_deep_analysis and paper.deep_analysis_preview %}
    <div class="detail-section">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-lightbulb"></i>
                    æ·±åº¦åˆ†æå†…å®¹é¢„è§ˆ
                    <span class="badge bg-light text-success ms-2">AI æ·±åº¦åˆ†æ</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="detail-content markdown-content">
                    {{ paper.deep_analysis_preview|markdown|safe }}
                </div>
                <div class="mt-3">
                    <a href="{{ url_for('explore.paper_analysis_view', arxiv_id=paper.arxiv_id) }}" 
                       class="btn btn-success">
                        <i class="bi bi-eye"></i> æŸ¥çœ‹å®Œæ•´æ·±åº¦åˆ†æ
                    </a>
                    <a href="{{ url_for('api.api_download_analysis', arxiv_id=paper.arxiv_id) }}" 
                       class="btn btn-outline-success ms-2">
                        <i class="bi bi-download"></i> ä¸‹è½½åˆ†æç»“æœ
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    
    <!-- ç»“æ„åŒ–åˆ†æ -->
    {% if not paper.has_deep_analysis and (paper.research_background or paper.research_objectives or paper.methods or paper.key_findings or paper.conclusions or paper.limitations or paper.future_work) %}
    <div class="detail-section">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-diagram-3"></i>
                    ç»“æ„åŒ–åˆ†æ
                    <span class="badge bg-light text-info ms-2">æ•°æ®åº“ç¿»è¯‘</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-info-circle"></i>
                        ä»¥ä¸‹å†…å®¹æ¥è‡ªæ•°æ®åº“å­˜å‚¨çš„ç¿»è¯‘æ•°æ®ï¼Œè´¨é‡å¯èƒ½æœ‰é™ã€‚å»ºè®®è¿›è¡Œæ·±åº¦åˆ†æä»¥è·å¾—æ›´ä¼˜è´¨çš„å†…å®¹ã€‚
                    </div>
                    <button id="deep-analysis-btn-alt-{{ paper.arxiv_id }}" class="btn btn-success btn-sm start-deep-analysis" data-arxiv-id="{{ paper.arxiv_id }}">
                        <i class="bi bi-lightbulb"></i> ç«‹å³æ·±åº¦åˆ†æ
                    </button>
                </div>
                <div class="row">
                    {% if paper.research_background %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">ç ”ç©¶èƒŒæ™¯</div>
                        <div class="detail-content markdown-content">{{ paper.research_background|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.research_objectives %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">ç ”ç©¶ç›®æ ‡</div>
                        <div class="detail-content markdown-content">{{ paper.research_objectives|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.methods %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">ç ”ç©¶æ–¹æ³•</div>
                        <div class="detail-content markdown-content">{{ paper.methods|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.key_findings %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">ä¸»è¦å‘ç°</div>
                        <div class="detail-content markdown-content">{{ paper.key_findings|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.conclusions %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">ç»“è®º</div>
                        <div class="detail-content markdown-content">{{ paper.conclusions|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.limitations %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">å±€é™æ€§</div>
                        <div class="detail-content markdown-content">{{ paper.limitations|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.future_work %}
                    <div class="col-md-12 mb-3">
                        <div class="detail-label">æœªæ¥å·¥ä½œ</div>
                        <div class="detail-content markdown-content">{{ paper.future_work|markdown|safe }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- å…³é”®è¯ -->
    {% if paper.keywords %}
    <div class="detail-section">
        <div class="detail-label">å…³é”®è¯</div>
        <div class="detail-content">
            {% for keyword in paper.keywords.split(',') %}
            <span class="tag">{{ keyword | safe_strip }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- æ ‡ç­¾ -->
    {% if paper.tags %}
    <div class="detail-section">
        <div class="detail-label">æ ‡ç­¾</div>
        <div class="detail-content">
            {% for tag in paper.tags %}
            <span class="tag">{{ tag }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    
</div>

<!-- ç›¸å…³æ“ä½œ -->
<div class="row mt-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-link-45deg"></i>
                    ç›¸å…³æ“ä½œ
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('explore.papers', category=(paper.categories.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-primary btn-sm w-100">
                            <i class="bi bi-tag"></i>
                            æŸ¥çœ‹åŒç±»è®ºæ–‡
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('explore.papers', q=(paper.authors.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-info btn-sm w-100">
                            <i class="bi bi-person"></i>
                            æŸ¥çœ‹åŒä½œè€…è®ºæ–‡
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        {% if paper.keywords %}
                        <a href="{{ url_for('explore.papers', q=(paper.keywords.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-success btn-sm w-100">
                            <i class="bi bi-key"></i>
                            æŸ¥çœ‹ç›¸å…³å…³é”®è¯
                        </a>
                        {% else %}
                        <button class="btn btn-outline-secondary btn-sm w-100" disabled>
                            <i class="bi bi-key"></i>
                            æ— å…³é”®è¯æ•°æ®
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- è‡ªå®šä¹‰æç¤ºè¯æ¨¡æ€æ¡† -->
<div class="modal fade" id="customPromptModal" tabindex="-1" aria-labelledby="customPromptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="customPromptModalLabel">
                    <i class="bi bi-lightbulb"></i> æ·±åº¦åˆ†æ - è‡ªå®šä¹‰æç¤ºè¯
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
                <div class="mb-4">
                    <div class="d-flex align-items-center">
                        <div class="step-indicator active me-3" id="step1-indicator">
                            <span class="step-number">1</span>
                        </div>
                        <div class="step-title active me-3" id="step1-title">é€‰æ‹©åˆ†æç±»å‹</div>
                        <div class="step-divider me-3"></div>
                        <div class="step-indicator me-3" id="step2-indicator">
                            <span class="step-number">2</span>
                        </div>
                        <div class="step-title text-muted" id="step2-title">è¾“å…¥è‡ªå®šä¹‰æç¤º</div>
                    </div>
                </div>

                <!-- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©åˆ†æç±»å‹ -->
                <div id="step1-content">
                    <div class="mb-4">
                        <h6><i class="bi bi-question-circle"></i> è¯·é€‰æ‹©æ·±åº¦åˆ†æçš„æ–¹å¼</h6>
                        <p class="text-muted">æ‚¨å¯ä»¥ä½¿ç”¨æ ‡å‡†åˆ†ææ¨¡å¼ï¼Œæˆ–è€…æ·»åŠ è‡ªå®šä¹‰æç¤ºè¯æ¥æŒ‡å¯¼AIåˆ†æ</p>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100 border-2">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="bi bi-lightning-charge text-primary" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h6 class="card-title">æ ‡å‡†æ·±åº¦åˆ†æ</h6>
                                    <p class="card-text text-muted">ä½¿ç”¨é»˜è®¤é…ç½®å¿«é€Ÿå¼€å§‹æ·±åº¦åˆ†æ</p>
                                    <button type="button" class="btn btn-primary" onclick="startAnalysisWithoutPrompt()">
                                        <i class="bi bi-play-fill"></i> ç«‹å³å¼€å§‹
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-2">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="bi bi-pencil-square text-warning" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h6 class="card-title">è‡ªå®šä¹‰æ·±åº¦åˆ†æ</h6>
                                    <p class="card-text text-muted">æ·»åŠ è‡ªå®šä¹‰æç¤ºè¯æŒ‡å¯¼AIæ·±åº¦åˆ†æ</p>
                                    <button type="button" class="btn btn-warning" onclick="proceedToCustomPrompt()">
                                        <i class="bi bi-pencil"></i> è‡ªå®šä¹‰æç¤º
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¬¬äºŒæ­¥ï¼šè¾“å…¥è‡ªå®šä¹‰æç¤ºè¯ -->
                <div id="step2-content" style="display: none;">
                    <div class="mb-4">
                        <h6><i class="bi bi-pencil-square"></i> è¯·è¾“å…¥æ‚¨çš„è‡ªå®šä¹‰æç¤ºè¯</h6>
                        <p class="text-muted">æè¿°æ‚¨å¸Œæœ›AIåœ¨åˆ†ææ—¶ç‰¹åˆ«å…³æ³¨çš„æ–¹é¢æˆ–è§’åº¦</p>
                    </div>

                    <!-- æç¤ºè¯è¾“å…¥åŒºåŸŸ -->
                    <div class="mb-4">
                        <label for="customPromptInput" class="form-label">
                            <i class="bi bi-chat-text"></i> è‡ªå®šä¹‰æç¤ºè¯
                        </label>
                        <textarea class="form-control" id="customPromptInput" rows="4" 
                                  placeholder="ä¾‹å¦‚ï¼šè¯·é‡ç‚¹å…³æ³¨è®ºæ–‡çš„åˆ›æ–°ç‚¹å’ŒæŠ€æœ¯æ–¹æ³•..." 
                                  maxlength="500" oninput="updatePromptCharCount()"></textarea>
                        <div class="form-text d-flex justify-content-between">
                            <small>å»ºè®®å­—æ•°ï¼š20-200å­—ï¼Œæœ‰åŠ©äºè·å¾—æ›´å‡†ç¡®çš„åˆ†æç»“æœ</small>
                            <small><span id="promptCharCount">0</span>/500</small>
                        </div>
                    </div>

                    <!-- å¿«é€Ÿæ¨¡æ¿ -->
                    <div class="mb-4">
                        <h6 class="mb-3"><i class="bi bi-lightning-charge"></i> å¿«é€Ÿæ¨¡æ¿</h6>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-start" 
                                        onclick="usePromptTemplate('method')">
                                    <i class="bi bi-gear"></i> å…³æ³¨æŠ€æœ¯æ–¹æ³•
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-start" 
                                        onclick="usePromptTemplate('application')">
                                    <i class="bi bi-rocket"></i> å…³æ³¨åº”ç”¨åœºæ™¯
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-start" 
                                        onclick="usePromptTemplate('innovation')">
                                    <i class="bi bi-star"></i> å…³æ³¨åˆ›æ–°ç‚¹
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-start" 
                                        onclick="usePromptTemplate('evaluation')">
                                    <i class="bi bi-graph-up"></i> å…³æ³¨è¯„ä¼°æ–¹æ³•
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- è¿”å›å’Œç»§ç»­æŒ‰é’® -->
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" onclick="backToStep1()">
                            <i class="bi bi-arrow-left"></i> è¿”å›
                        </button>
                        <button type="button" class="btn btn-primary" id="startCustomAnalysisBtn" onclick="startAnalysisWithCustomPrompt()">
                            <i class="bi bi-lightbulb"></i> å¼€å§‹æ·±åº¦åˆ†æ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ä»»åŠ¡è¿ç§»æ¨¡æ€æ¡† -->
<div class="modal fade" id="migrationModal" tabindex="-1" aria-labelledby="migrationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="migrationModalLabel">
                    <i class="bi bi-arrow-right-circle"></i> è¿ç§»åˆ°å·²æœ‰ä»»åŠ¡
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>è®ºæ–‡:</strong> <span id="migrationPaperTitle"></span>
                </div>
                
                <!-- ä»»åŠ¡æœç´¢ -->
                <div class="mb-3">
                    <label for="taskSearchInput" class="form-label">æœç´¢ä»»åŠ¡</label>
                    <input type="text" class="form-control" id="taskSearchInput" 
                           placeholder="è¾“å…¥ä»»åŠ¡åç§°è¿›è¡Œæœç´¢..." 
                           onkeyup="filterTasks()">
                </div>
                
                <!-- ä»»åŠ¡åˆ—è¡¨ -->
                <div id="taskListContainer" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2">æ­£åœ¨åŠ è½½ä»»åŠ¡åˆ—è¡¨...</p>
                    </div>
                </div>
                
                <!-- è¿ç§»çŠ¶æ€æ˜¾ç¤º -->
                <div id="migrationStatus" class="alert d-none mt-3" role="alert">
                    <span id="migrationStatusMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" id="confirmMigrationBtn" onclick="confirmMigration()" disabled>
                    <i class="bi bi-check-circle"></i> ç¡®è®¤è¿ç§»
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<style>
    .cursor-pointer {
        cursor: pointer;
    }
    
    .task-option {
        transition: all 0.2s ease;
    }
    
    .task-option:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }
    
    .task-option.border-primary {
        border-width: 2px !important;
    }
    
    /* Toast åŠ¨ç”» */
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    /* ç¦ç”¨çŠ¶æ€çš„æ·±åº¦åˆ†ææŒ‰é’®æ ·å¼ */
    .start-deep-analysis:disabled,
    .start-deep-analysis.disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
    }
    
    .start-deep-analysis:disabled .bi-hourglass-split {
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* è‡ªå®šä¹‰æç¤ºè¯æ¨¡æ€æ¡†æ ·å¼ */
    .step-indicator {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .step-indicator.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .step-indicator .step-number {
        color: #6c757d;
        font-weight: bold;
        font-size: 14px;
    }
    
    .step-indicator.active .step-number {
        color: white;
    }
    
    .step-title {
        font-weight: 500;
        transition: color 0.3s ease;
    }
    
    .step-title.active {
        color: #0d6efd;
    }
    
    .step-divider {
        width: 40px;
        height: 2px;
        background: #e9ecef;
        margin: 0 10px;
    }
    
    #customPromptModal .card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    #customPromptModal .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
        border-color: var(--bs-primary);
    }
    
    #customPromptInput {
        resize: vertical;
        min-height: 100px;
    }
    
    #customPromptInput:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
</style>

<script>
    // æ·±åº¦åˆ†æåŠŸèƒ½JavaScript - å‚è€ƒé‡æ–°åˆ†ææŒ‰é’®çš„æˆåŠŸæ¨¡å¼
    console.log('ğŸš€ å¼€å§‹åŠ è½½è®ºæ–‡è¯¦æƒ…é¡µé¢æ·±åº¦åˆ†æJavaScript');
    console.log('ğŸ“ å½“å‰é¡µé¢URL:', window.location.href);
    console.log('ğŸ“ é¡µé¢åŠ è½½çŠ¶æ€:', document.readyState);
    console.log('ğŸ“ å½“å‰æ—¶é—´:', new Date().toLocaleTimeString());
    
    // å…¨å±€å‡½æ•°ï¼šå¯åŠ¨æ·±åº¦åˆ†æ - æ–°ç‰ˆæœ¬æ”¯æŒè‡ªå®šä¹‰æç¤ºè¯
    function startDeepAnalysis(arxivId) {
        console.log('ğŸš€ å¯åŠ¨æ·±åº¦åˆ†æå‡½æ•°è¢«è°ƒç”¨, ArXiv ID:', arxivId);
        
        if (!arxivId) {
            console.error('âŒ æ— æ³•è·å–è®ºæ–‡ID');
            alert('æ— æ³•è·å–è®ºæ–‡IDï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }
        
        // å­˜å‚¨å½“å‰ArXiv IDä¾›æ¨¡æ€æ¡†ä½¿ç”¨
        window.currentAnalysisArxivId = arxivId;
        
        // é‡ç½®æ¨¡æ€æ¡†çŠ¶æ€
        resetCustomPromptModal();
        
        // æ˜¾ç¤ºè‡ªå®šä¹‰æç¤ºè¯æ¨¡æ€æ¡†
        console.log('ğŸ¯ æ˜¾ç¤ºè‡ªå®šä¹‰æç¤ºè¯é€‰æ‹©æ¨¡æ€æ¡†');
        const modal = new bootstrap.Modal(document.getElementById('customPromptModal'));
        modal.show();
        
    }
    
    console.log('âœ… startDeepAnalysiså‡½æ•°å®šä¹‰å®Œæˆ');
    console.log('ğŸ” startDeepAnalysiså‡½æ•°ç±»å‹:', typeof startDeepAnalysis);
    
    // === è‡ªå®šä¹‰æç¤ºè¯æ¨¡æ€æ¡†ç›¸å…³å‡½æ•° ===
    
    // é‡ç½®æ¨¡æ€æ¡†çŠ¶æ€
    function resetCustomPromptModal() {
        // é‡ç½®æ­¥éª¤æŒ‡ç¤ºå™¨
        document.getElementById('step1-indicator').classList.add('active');
        document.getElementById('step2-indicator').classList.remove('active');
        document.getElementById('step1-title').classList.remove('text-muted');
        document.getElementById('step2-title').classList.add('text-muted');
        
        // æ˜¾ç¤ºç¬¬ä¸€æ­¥ï¼Œéšè—ç¬¬äºŒæ­¥
        document.getElementById('step1-content').style.display = 'block';
        document.getElementById('step2-content').style.display = 'none';
        
        // æ¸…ç©ºæç¤ºè¯è¾“å…¥æ¡†
        document.getElementById('customPromptInput').value = '';
        updatePromptCharCount();
    }
    
    // è¿›å…¥è‡ªå®šä¹‰æç¤ºè¯è¾“å…¥æ­¥éª¤
    function proceedToCustomPrompt() {
        // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
        document.getElementById('step1-indicator').classList.remove('active');
        document.getElementById('step2-indicator').classList.add('active');
        document.getElementById('step1-title').classList.add('text-muted');
        document.getElementById('step2-title').classList.remove('text-muted');
        document.getElementById('step2-title').classList.add('active');
        
        // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
        document.getElementById('step1-content').style.display = 'none';
        document.getElementById('step2-content').style.display = 'block';
        
        // èšç„¦åˆ°è¾“å…¥æ¡†
        setTimeout(() => {
            document.getElementById('customPromptInput').focus();
        }, 300);
    }
    
    // è¿”å›ç¬¬ä¸€æ­¥
    function backToStep1() {
        // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
        document.getElementById('step1-indicator').classList.add('active');
        document.getElementById('step2-indicator').classList.remove('active');
        document.getElementById('step1-title').classList.remove('text-muted');
        document.getElementById('step2-title').classList.add('text-muted');
        document.getElementById('step2-title').classList.remove('active');
        
        // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
        document.getElementById('step1-content').style.display = 'block';
        document.getElementById('step2-content').style.display = 'none';
    }
    
    // ä½¿ç”¨æç¤ºè¯æ¨¡æ¿
    function usePromptTemplate(templateType) {
        const templates = {
            'method': 'è¯·ç‰¹åˆ«å…³æ³¨è®ºæ–‡ä¸­çš„æŠ€æœ¯æ–¹æ³•å’Œç®—æ³•å®ç°ï¼Œåˆ†æå…¶åˆ›æ–°æ€§ã€å¤æ‚åº¦å’Œå®ç”¨æ€§ã€‚',
            'application': 'è¯·é‡ç‚¹åˆ†æè®ºæ–‡çš„åº”ç”¨åœºæ™¯å’Œå®é™…éƒ¨ç½²æƒ…å†µï¼Œè¯„ä¼°å…¶å•†ä¸šä»·å€¼å’Œå®é™…åº”ç”¨æ½œåŠ›ã€‚',
            'innovation': 'è¯·ç€é‡åˆ†æè®ºæ–‡çš„åˆ›æ–°ç‚¹å’Œçªç ´æ€§è´¡çŒ®ï¼Œå¯¹æ¯”ç°æœ‰æŠ€æœ¯çš„ä¼˜åŠ¿å’Œå±€é™æ€§ã€‚',
            'evaluation': 'è¯·è¯¦ç»†åˆ†æè®ºæ–‡çš„å®éªŒè®¾è®¡ã€è¯„ä¼°æ–¹æ³•å’Œæ€§èƒ½æŒ‡æ ‡ï¼Œè¯„ä¼°å®éªŒç»“æœçš„å¯ä¿¡åº¦ã€‚'
        };
        
        const template = templates[templateType];
        if (template) {
            document.getElementById('customPromptInput').value = template;
            updatePromptCharCount();
        }
    }
    
    // æ›´æ–°å­—ç¬¦è®¡æ•°
    function updatePromptCharCount() {
        const input = document.getElementById('customPromptInput');
        const counter = document.getElementById('promptCharCount');
        if (input && counter) {
            const length = input.value.length;
            counter.textContent = `${length}/500`;
            
            // æ ¹æ®å­—ç¬¦æ•°æ”¹å˜é¢œè‰²
            if (length > 450) {
                counter.classList.add('text-warning');
                counter.classList.remove('text-muted');
            } else if (length >= 500) {
                counter.classList.add('text-danger');
                counter.classList.remove('text-warning', 'text-muted');
            } else {
                counter.classList.remove('text-warning', 'text-danger');
                counter.classList.add('text-muted');
            }
        }
    }
    
    // ä¸ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯ç›´æ¥å¼€å§‹åˆ†æ
    function startAnalysisWithoutPrompt() {
        console.log('ğŸš€ ç”¨æˆ·é€‰æ‹©æ ‡å‡†åˆ†ææ¨¡å¼');
        
        // å…³é—­æ¨¡æ€æ¡†
        const modal = bootstrap.Modal.getInstance(document.getElementById('customPromptModal'));
        if (modal) {
            modal.hide();
        }
        
        // æ‰§è¡Œæ ‡å‡†åˆ†æ
        executeDeepAnalysis(window.currentAnalysisArxivId, false, null);
    }
    
    // ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯å¼€å§‹åˆ†æ
    function startAnalysisWithCustomPrompt() {
        console.log('ğŸš€ ç”¨æˆ·é€‰æ‹©è‡ªå®šä¹‰åˆ†ææ¨¡å¼');
        
        const customPrompt = document.getElementById('customPromptInput').value.trim();
        
        // éªŒè¯æç¤ºè¯
        if (!customPrompt) {
            alert('è¯·è¾“å…¥è‡ªå®šä¹‰æç¤ºè¯åå†ç»§ç»­');
            document.getElementById('customPromptInput').focus();
            return;
        }
        
        if (customPrompt.length < 10) {
            alert('æç¤ºè¯å¤ªçŸ­ï¼Œè¯·è¾“å…¥è‡³å°‘10ä¸ªå­—ç¬¦çš„è¯¦ç»†æè¿°');
            document.getElementById('customPromptInput').focus();
            return;
        }
        
        console.log('âœ… è‡ªå®šä¹‰æç¤ºè¯éªŒè¯é€šè¿‡:', customPrompt);
        
        // å…³é—­æ¨¡æ€æ¡†
        const modal = bootstrap.Modal.getInstance(document.getElementById('customPromptModal'));
        if (modal) {
            modal.hide();
        }
        
        // æ‰§è¡Œè‡ªå®šä¹‰åˆ†æ
        executeDeepAnalysis(window.currentAnalysisArxivId, true, customPrompt);
    }
    
    // æ‰§è¡Œæ·±åº¦åˆ†æçš„æ ¸å¿ƒå‡½æ•°
    function executeDeepAnalysis(arxivId, enableUserPrompt, userPrompt) {
        console.log('ğŸš€ å¼€å§‹æ‰§è¡Œæ·±åº¦åˆ†æ');
        console.log('ğŸ“„ ArXiv ID:', arxivId);
        console.log('ğŸ¯ å¯ç”¨ç”¨æˆ·æç¤ºè¯:', enableUserPrompt);
        console.log('ğŸ“ ç”¨æˆ·æç¤ºè¯:', userPrompt);
        
        if (!arxivId) {
            console.error('âŒ æ— æ³•è·å–è®ºæ–‡ID');
            alert('æ— æ³•è·å–è®ºæ–‡IDï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }
        
        // ç¦ç”¨æ·±åº¦åˆ†ææŒ‰é’®
        const primaryBtn = document.getElementById('deep-analysis-btn-' + arxivId);
        const altBtn = document.getElementById('deep-analysis-btn-alt-' + arxivId);
        
        if (primaryBtn) {
            primaryBtn.disabled = true;
            primaryBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> åˆ†æä¸­...';
            console.log('ğŸ”’ ä¸»è¦åˆ†ææŒ‰é’®å·²ç¦ç”¨');
        }
        if (altBtn) {
            altBtn.disabled = true;
            altBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> åˆ†æä¸­...';
            console.log('ğŸ”’ å¤‡é€‰åˆ†ææŒ‰é’®å·²ç¦ç”¨');
        }
        
        console.log('ğŸ“¤ å‡†å¤‡è°ƒç”¨æ·±åº¦åˆ†æAPI');
        
        // æ„å»ºè¯·æ±‚å‚æ•°
        const requestBody = {
            config: {
                enable_user_prompt: enableUserPrompt,
                user_prompt: userPrompt || ''
            }
        };
        
        // è·å–ç³»ç»Ÿé…ç½®å¹¶åˆå¹¶
        const configPromise = window.SystemSettings ? 
            window.SystemSettings.getAnalysisConfig().then(config => {
                console.log('âœ… æˆåŠŸè·å–ç³»ç»Ÿé…ç½®:', config);
                // åˆå¹¶ç³»ç»Ÿé…ç½®å’Œç”¨æˆ·æç¤ºè¯é…ç½®
                requestBody.config = {...config, ...requestBody.config};
                return requestBody;
            }).catch(error => {
                console.warn('âš ï¸ è·å–ç³»ç»Ÿé…ç½®å¤±è´¥ï¼Œä½¿ç”¨åŸºæœ¬é…ç½®:', error);
                return requestBody;
            }) :
            Promise.resolve(requestBody);
        
        const apiUrl = '/api/analysis/paper/' + arxivId + '/analyze';
        console.log('ğŸš€ APIè¯·æ±‚URL:', apiUrl);
        
        configPromise
            .then(finalRequestBody => {
                console.log('ğŸ“¤ æœ€ç»ˆè¯·æ±‚é…ç½®:', finalRequestBody);
                
                return fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(finalRequestBody)
                });
            })
            .then(response => {
                console.log('ğŸ“¨ æ”¶åˆ°APIå“åº”ï¼ŒçŠ¶æ€ç :', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('ğŸ“Š APIå“åº”æ•°æ®:', data);
                
                if (data.success) {
                    console.log('âœ… æ·±åº¦åˆ†æå¯åŠ¨æˆåŠŸ');
                    const successMsg = enableUserPrompt ? 
                        'è‡ªå®šä¹‰æ·±åº¦åˆ†æå·²æˆåŠŸå¯åŠ¨ï¼AIå°†æ ¹æ®æ‚¨çš„æç¤ºè¯è¿›è¡Œä¸“é¡¹åˆ†æï¼Œæ­£åœ¨åå°å¤„ç†ä¸­...' :
                        'æ ‡å‡†æ·±åº¦åˆ†æå·²æˆåŠŸå¯åŠ¨ï¼æ­£åœ¨åå°å¤„ç†ä¸­ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç›‘æ§è¿›åº¦...';
                    alert(successMsg);
                    
                    // å¯åŠ¨çŠ¶æ€è½®è¯¢
                    startDeepAnalysisPolling(arxivId);
                } else {
                    console.error('âŒ åˆ†æå¯åŠ¨å¤±è´¥:', data.error);
                    alert('å¯åŠ¨åˆ†æå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    restoreAnalysisButtons(arxivId);
                }
            })
            .catch(error => {
                console.error('ğŸ’¥ æ·±åº¦åˆ†æAPIè°ƒç”¨å¤±è´¥:', error);
                alert('å¯åŠ¨åˆ†ææ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                restoreAnalysisButtons(arxivId);
            });
    }
    
    // æ¢å¤åˆ†ææŒ‰é’®çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
    function restoreAnalysisButtons(arxivId) {
        const primaryBtn = document.getElementById('deep-analysis-btn-' + arxivId);
        const altBtn = document.getElementById('deep-analysis-btn-alt-' + arxivId);
        
        if (primaryBtn) {
            primaryBtn.disabled = false;
            primaryBtn.innerHTML = '<i class="bi bi-lightbulb"></i> å¼€å§‹æ·±åº¦åˆ†æ';
        }
        if (altBtn) {
            altBtn.disabled = false;
            altBtn.innerHTML = '<i class="bi bi-lightbulb"></i> ç«‹å³æ·±åº¦åˆ†æ';
        }
    }
    
    // æ™ºèƒ½è·å–ArXiv IDçš„å‡½æ•°
    function getArxivIdFromPage() {
        // æ–¹æ³•1: ä»URLè·¯å¾„è§£æ (/explore/paper/ARXIV_ID)
        const urlPath = window.location.pathname;
        const pathMatch = urlPath.match(/\/explore\/paper\/([^\/]+)/);
        if (pathMatch && pathMatch[1]) {
            console.log('âœ… ä»URLè·¯å¾„è·å–åˆ°ArXiv ID:', pathMatch[1]);
            return pathMatch[1];
        }
        
        // æ–¹æ³•2: ä»DOMå…ƒç´ è·å–ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
        const arxivIdElement = document.querySelector('[data-arxiv-id]');
        if (arxivIdElement) {
            const arxivId = arxivIdElement.getAttribute('data-arxiv-id');
            console.log('âœ… ä»DOMå…ƒç´ è·å–åˆ°ArXiv ID:', arxivId);
            return arxivId;
        }
        
        console.error('âŒ æ— æ³•ä»URLæˆ–DOMä¸­è·å–ArXiv ID');
        return null;
    }
    
    // DOMContentLoadedäº‹ä»¶å¤„ç†ï¼ˆå®Œå…¨å‚è€ƒé‡æ–°åˆ†ææŒ‰é’®çš„æ¨¡å¼ï¼‰
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ¯ DOMContentLoadedäº‹ä»¶è§¦å‘');
        
        // ä½¿ç”¨æ™ºèƒ½æ–¹æ³•è·å–ArXiv ID
        const arxivId = getArxivIdFromPage();
        console.log('ğŸ“„ é¡µé¢ArXiv ID:', arxivId);
        
        if (!arxivId) {
            console.error('âŒ æ— æ³•è·å–ArXiv IDï¼Œæ·±åº¦åˆ†æåŠŸèƒ½å°†æ— æ³•ä½¿ç”¨');
            return;
        }
        
        // ç»‘å®šä¸»è¦æ·±åº¦åˆ†ææŒ‰é’®äº‹ä»¶
        console.log('ğŸ” å¼€å§‹ç»‘å®šä¸»è¦æ·±åº¦åˆ†ææŒ‰é’®äº‹ä»¶');
        const primaryBtn = document.getElementById('deep-analysis-btn-' + arxivId);
        console.log('ğŸ” æ‰¾åˆ°ä¸»è¦åˆ†ææŒ‰é’®:', primaryBtn);
        
        if (primaryBtn) {
            console.log('âœ… ä¸»è¦åˆ†ææŒ‰é’®å­˜åœ¨ï¼Œå¼€å§‹ç»‘å®šäº‹ä»¶');
            primaryBtn.addEventListener('click', function(e) {
                console.log('ğŸ”¥ ä¸»è¦æ·±åº¦åˆ†ææŒ‰é’®è¢«ç‚¹å‡»!');
                e.preventDefault();
                
                const buttonArxivId = this.getAttribute('data-arxiv-id');
                console.log('ğŸ“„ è·å–åˆ°æŒ‰é’®ArXiv ID:', buttonArxivId);
                console.log('ğŸ” startDeepAnalysiså‡½æ•°ç±»å‹:', typeof startDeepAnalysis);
                
                if (buttonArxivId && typeof startDeepAnalysis === 'function') {
                    console.log('âœ… å¼€å§‹è°ƒç”¨startDeepAnalysiså‡½æ•°');
                    startDeepAnalysis(buttonArxivId);
                } else {
                    console.error('âŒ startDeepAnalysiså‡½æ•°ä¸å¯ç”¨æˆ–ArXiv IDç¼ºå¤±');
                    console.error('   ArXiv ID:', buttonArxivId);
                    console.error('   å‡½æ•°ç±»å‹:', typeof startDeepAnalysis);
                }
            });
            console.log('âœ… ä¸»è¦æ·±åº¦åˆ†ææŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ');
        } else {
            console.log('â„¹ï¸ ä¸»è¦æ·±åº¦åˆ†ææŒ‰é’®æœªæ‰¾åˆ°ï¼ˆå¯èƒ½å¤„äºä¸åŒçŠ¶æ€ï¼‰');
        }
        
        // ç»‘å®šå¤‡é€‰æ·±åº¦åˆ†ææŒ‰é’®äº‹ä»¶
        console.log('ğŸ” å¼€å§‹ç»‘å®šå¤‡é€‰æ·±åº¦åˆ†ææŒ‰é’®äº‹ä»¶');
        const altBtn = document.getElementById('deep-analysis-btn-alt-' + arxivId);
        console.log('ğŸ” æ‰¾åˆ°å¤‡é€‰åˆ†ææŒ‰é’®:', altBtn);
        
        if (altBtn) {
            console.log('âœ… å¤‡é€‰åˆ†ææŒ‰é’®å­˜åœ¨ï¼Œå¼€å§‹ç»‘å®šäº‹ä»¶');
            altBtn.addEventListener('click', function(e) {
                console.log('ğŸ”¥ å¤‡é€‰æ·±åº¦åˆ†ææŒ‰é’®è¢«ç‚¹å‡»!');
                e.preventDefault();
                
                const buttonArxivId = this.getAttribute('data-arxiv-id');
                console.log('ğŸ“„ è·å–åˆ°æŒ‰é’®ArXiv ID:', buttonArxivId);
                
                if (buttonArxivId && typeof startDeepAnalysis === 'function') {
                    console.log('âœ… å¼€å§‹è°ƒç”¨startDeepAnalysiså‡½æ•°');
                    startDeepAnalysis(buttonArxivId);
                } else {
                    console.error('âŒ startDeepAnalysiså‡½æ•°ä¸å¯ç”¨æˆ–ArXiv IDç¼ºå¤±');
                }
            });
            console.log('âœ… å¤‡é€‰æ·±åº¦åˆ†ææŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ');
        } else {
            console.log('â„¹ï¸ å¤‡é€‰æ·±åº¦åˆ†ææŒ‰é’®æœªæ‰¾åˆ°');
        }
        
        console.log('ğŸ¯ æ·±åº¦åˆ†ææŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ');
    });
    
    // Global function: Cancel Deep Analysis  
    function cancelAnalysis(arxivId) {
        console.log('ğŸ”¥ cancelAnalysisè¢«è°ƒç”¨! arxivId:', arxivId);
        
        if (!confirm('ç¡®å®šè¦å–æ¶ˆæ·±åº¦åˆ†æå—ï¼Ÿ\n\næ­£åœ¨è¿›è¡Œçš„åˆ†æä»»åŠ¡å°†è¢«ç»ˆæ­¢ã€‚')) {
            return;
        }
        
        const analysisSection = document.getElementById('deep-analysis-section');
        const originalContent = analysisSection.innerHTML;
        
        // æ˜¾ç¤ºå–æ¶ˆä¸­çŠ¶æ€
        analysisSection.innerHTML = `
            <div class="d-grid gap-2">
                <button class="btn btn-warning w-100" disabled>
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">å–æ¶ˆä¸­...</span>
                    </div>
                    æ­£åœ¨å–æ¶ˆåˆ†æ...
                </button>
            </div>
        `;
        
        // å‘é€å–æ¶ˆè¯·æ±‚
        fetch('/api/analysis/paper/' + arxivId + '/cancel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('åˆ†æä»»åŠ¡å·²æˆåŠŸå–æ¶ˆï¼', 'success');
                // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ›´æ–°çŠ¶æ€
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showAlert('å–æ¶ˆåˆ†æå¤±è´¥: ' + data.error, 'error');
                // æ¢å¤åŸå§‹çŠ¶æ€
                analysisSection.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('å–æ¶ˆåˆ†æå¤±è´¥:', error);
            showAlert('å–æ¶ˆåˆ†ææ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
            // æ¢å¤åŸå§‹çŠ¶æ€
            analysisSection.innerHTML = originalContent;
        });
    }
    
    // Global function: Reset Analysis Status
    function resetAnalysisStatus(arxivId) {
        console.log('ğŸ”„ resetAnalysisStatusè¢«è°ƒç”¨! arxivId:', arxivId);
        
        if (!confirm('ç¡®å®šè¦é‡ç½®è¯¥è®ºæ–‡çš„åˆ†æçŠ¶æ€å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤æ‰€æœ‰ç›¸å…³çš„åˆ†æè®°å½•å’ŒçŠ¶æ€ã€‚')) {
            return;
        }
        
        const analysisSection = document.getElementById('deep-analysis-section');
        const originalContent = analysisSection.innerHTML;
        
        // æ˜¾ç¤ºé‡ç½®ä¸­çŠ¶æ€
        analysisSection.innerHTML = `
            <div class="d-grid gap-2">
                <button class="btn btn-secondary w-100" disabled>
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">é‡ç½®ä¸­...</span>
                    </div>
                    æ­£åœ¨é‡ç½®çŠ¶æ€...
                </button>
            </div>
        `;
        
        // å‘é€é‡ç½®è¯·æ±‚
        fetch('/api/analysis/paper/' + arxivId + '/reset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('åˆ†æçŠ¶æ€å·²æˆåŠŸé‡ç½®ï¼', 'success');
                // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ›´æ–°çŠ¶æ€
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showAlert('é‡ç½®çŠ¶æ€å¤±è´¥: ' + data.error, 'error');
                // æ¢å¤åŸå§‹çŠ¶æ€
                analysisSection.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('é‡ç½®çŠ¶æ€å¤±è´¥:', error);
            showAlert('é‡ç½®çŠ¶æ€æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
            // æ¢å¤åŸå§‹çŠ¶æ€
            analysisSection.innerHTML = originalContent;
        });
    }
    
    // å…¨å±€å‡½æ•°ï¼šæ·±åº¦åˆ†æçŠ¶æ€è½®è¯¢
    function startDeepAnalysisPolling(arxivId) {
        console.log('ğŸ”„ å¼€å§‹æ·±åº¦åˆ†æçŠ¶æ€è½®è¯¢:', arxivId);
        
        const pollInterval = setInterval(() => {
            console.log('ğŸ“¡ è½®è¯¢åˆ†æçŠ¶æ€:', arxivId);
            
            fetch(`/api/analysis/paper/${arxivId}/status`)
            .then(response => response.json())
            .then(data => {
                console.log('ğŸ“Š åˆ†æçŠ¶æ€è½®è¯¢ç»“æœ:', data);
                
                if (data.success) {
                    const status = data.status;
                    console.log('ğŸ“‹ å½“å‰åˆ†æçŠ¶æ€:', status);
                    
                    if (status === 'completed') {
                        clearInterval(pollInterval);
                        console.log('âœ… æ·±åº¦åˆ†æå®Œæˆï¼å‡†å¤‡åˆ·æ–°é¡µé¢');
                        showAlert('æ·±åº¦åˆ†æå®Œæˆï¼é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°æ˜¾ç¤ºç»“æœ...', 'success', 3000);
                        
                        // 3ç§’ååˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºåˆ†æç»“æœ
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                        
                    } else if (status === 'failed') {
                        clearInterval(pollInterval);
                        console.error('âŒ æ·±åº¦åˆ†æå¤±è´¥');
                        showAlert('æ·±åº¦åˆ†æå¤±è´¥ï¼Œè¯·æŸ¥çœ‹é”™è¯¯ä¿¡æ¯æˆ–é‡è¯•', 'error', 5000);
                        
                        // æ¢å¤æ·±åº¦åˆ†ææŒ‰é’®çŠ¶æ€
                        enableDeepAnalysisButtons(arxivId);
                        
                    } else if (status === 'cancelled') {
                        clearInterval(pollInterval);
                        console.log('âš ï¸ æ·±åº¦åˆ†æå·²è¢«å–æ¶ˆ');
                        showAlert('æ·±åº¦åˆ†æå·²è¢«å–æ¶ˆ', 'warning', 3000);
                        
                        // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ›´æ–°çŠ¶æ€
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                        
                    } else if (status === 'processing') {
                        // ç»§ç»­è½®è¯¢
                        console.log('â³ æ·±åº¦åˆ†æä»åœ¨è¿›è¡Œä¸­...');
                    } else {
                        console.log('ğŸ“ åˆ†æçŠ¶æ€:', status);
                    }
                } else {
                    console.error('âŒ è·å–åˆ†æçŠ¶æ€å¤±è´¥:', data.error);
                    // ä¸åœæ­¢è½®è¯¢ï¼Œç»§ç»­å°è¯•
                }
            })
            .catch(error => {
                console.error('ğŸ’¥ çŠ¶æ€è½®è¯¢ç½‘ç»œé”™è¯¯:', error);
                // ä¸åœæ­¢è½®è¯¢ï¼Œç»§ç»­å°è¯•
            });
        }, 5000); // æ¯5ç§’è½®è¯¢ä¸€æ¬¡
        
        // 15åˆ†é’Ÿååœæ­¢è½®è¯¢ï¼ˆé¿å…æ— é™è½®è¯¢ï¼‰
        setTimeout(() => {
            clearInterval(pollInterval);
            console.log('â° æ·±åº¦åˆ†æè½®è¯¢è¶…æ—¶ï¼Œåœæ­¢è½®è¯¢');
            showAlert('æ·±åº¦åˆ†æç›‘æ§è¶…æ—¶ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ', 'warning', 5000);
            
            // æ¢å¤æ·±åº¦åˆ†ææŒ‰é’®çŠ¶æ€
            enableDeepAnalysisButtons(arxivId);
        }, 15 * 60 * 1000); // 15åˆ†é’Ÿè¶…æ—¶
    }
    
    // Make functions globally accessible
    window.startDeepAnalysis = startDeepAnalysis;
    window.cancelAnalysis = cancelAnalysis;
    window.resetAnalysisStatus = resetAnalysisStatus;
    window.startDeepAnalysisPolling = startDeepAnalysisPolling;
    window.getArxivIdFromPage = getArxivIdFromPage;
    
    console.log('âœ… Deep analysis functions registered globally');
    console.log('startDeepAnalysis ç±»å‹:', typeof window.startDeepAnalysis);
    console.log('cancelDeepAnalysis ç±»å‹:', typeof window.cancelDeepAnalysis);
    console.log('getArxivIdFromPage ç±»å‹:', typeof window.getArxivIdFromPage);
    
    // Helper functions for button state management
    function restoreAnalysisButton(arxivId, analysisSection) {
        console.log('ğŸ”„ æ¢å¤æ·±åº¦åˆ†ææŒ‰é’®çŠ¶æ€:', arxivId);
        enableDeepAnalysisButtons(arxivId);
        analysisSection.innerHTML = `
            <button class="btn btn-outline-primary w-100 start-deep-analysis" data-arxiv-id="${arxivId}">
                <i class="bi bi-lightbulb"></i> å¼€å§‹æ·±åº¦åˆ†æ
            </button>
        `;
    }
    
    function disableDeepAnalysisButtons(arxivId) {
        console.log('ğŸ”’ ç¦ç”¨æ·±åº¦åˆ†ææŒ‰é’®:', arxivId);
        const buttons = document.querySelectorAll('.start-deep-analysis[data-arxiv-id="' + arxivId + '"]');
        buttons.forEach(button => {
            button.disabled = true;
            button.classList.add('disabled');
            // æ·»åŠ è§†è§‰æŒ‡ç¤º
            const originalText = button.innerHTML;
            button.setAttribute('data-original-text', originalText);
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> åˆ†æä¸­...';
        });
    }
    
    function enableDeepAnalysisButtons(arxivId) {
        console.log('ğŸ”“ å¯ç”¨æ·±åº¦åˆ†ææŒ‰é’®:', arxivId);
        const buttons = document.querySelectorAll('.start-deep-analysis[data-arxiv-id="' + arxivId + '"]');
        buttons.forEach(button => {
            button.disabled = false;
            button.classList.remove('disabled');
            // æ¢å¤åŸå§‹æ–‡æœ¬
            const originalText = button.getAttribute('data-original-text');
            if (originalText) {
                button.innerHTML = originalText;
                button.removeAttribute('data-original-text');
            }
        });
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥åˆ†æçŠ¶æ€å¹¶ç›¸åº”åœ°ç¦ç”¨æŒ‰é’®
    function checkAndDisableIfProcessing() {
        console.log('ğŸ” æ£€æŸ¥é¡µé¢åŠ è½½æ—¶çš„åˆ†æçŠ¶æ€...');
        
        // ä»é¡µé¢å…ƒç´ åˆ¤æ–­å½“å‰åˆ†æçŠ¶æ€
        const analysisSection = document.getElementById('deep-analysis-section');
        if (analysisSection) {
            // æ£€æŸ¥æ˜¯å¦æœ‰åˆ†æä¸­çš„æŒ‡ç¤ºå™¨
            const spinnerButton = analysisSection.querySelector('.spinner-border');
            const disabledButtons = analysisSection.querySelectorAll('button[disabled]');
            
            // æ£€æŸ¥æŒ‰é’®æ–‡æœ¬æ˜¯å¦åŒ…å«"åˆ†æè¿›è¡Œä¸­"æˆ–ç±»ä¼¼å†…å®¹
            let isProcessing = false;
            disabledButtons.forEach(button => {
                const buttonText = button.textContent || button.innerText;
                if (buttonText.includes('åˆ†æè¿›è¡Œä¸­') || buttonText.includes('åˆ†æä¸­')) {
                    isProcessing = true;
                }
            });
            
            if (spinnerButton || isProcessing) {
                console.log('ğŸ“Š æ£€æµ‹åˆ°åˆ†ææ­£åœ¨è¿›è¡Œä¸­ï¼Œç¡®ä¿æŒ‰é’®ä¿æŒç¦ç”¨çŠ¶æ€');
                // åˆ†ææ­£åœ¨è¿›è¡Œä¸­ï¼Œç¡®ä¿ç›¸å…³æŒ‰é’®ä¿æŒç¦ç”¨çŠ¶æ€
                const arxivIdElement = analysisSection.querySelector('[data-arxiv-id]');
                if (arxivIdElement) {
                    const arxivId = arxivIdElement.getAttribute('data-arxiv-id');
                    if (arxivId) {
                        // ç¦ç”¨é¡µé¢ä¸­çš„æ‰€æœ‰å¼€å§‹åˆ†ææŒ‰é’®
                        const startButtons = document.querySelectorAll('.start-deep-analysis[data-arxiv-id="' + arxivId + '"]');
                        startButtons.forEach(button => {
                            if (button && !button.disabled) {
                                button.disabled = true;
                                button.classList.add('disabled');
                                console.log('ğŸ”’ ç¦ç”¨äº†å¼€å§‹åˆ†ææŒ‰é’®');
                            }
                        });
                    }
                }
            }
        }
    }
    
    // ===== å…¶ä»–åŠŸèƒ½å‡½æ•° =====
    
    // æ›´æ–°è¯„åˆ†é¢„è§ˆ
    function updateScorePreview() {
        const score = parseFloat($('#relevance-score-input').val());
        const preview = $('#score-preview');
        
        if (isNaN(score) || score < 0 || score > 1) {
            preview.html('<span class="text-muted">â˜†â˜†â˜†â˜†â˜†</span>');
            return;
        }
        
        const starsCount = Math.round(score * 5);
        const filledStars = 'â˜…'.repeat(starsCount);
        const emptyStars = 'â˜†'.repeat(5 - starsCount);
        
        let colorClass;
        if (score >= 0.8) colorClass = 'text-success';
        else if (score >= 0.5) colorClass = 'text-warning';
        else colorClass = 'text-danger';
        
        preview.html(`<span class="${colorClass}">${filledStars}${emptyStars}</span> (${score.toFixed(2)})`);
    }
    
    // æ›´æ–°å­—ç¬¦è®¡æ•°
    function updateCharCount() {
        const text = $('#relevance-justification-input').val();
        $('#char-count').text(text.length);
    }
    
    // ç†ç”±æ¨¡æ¿
    const templates = {
        method: "è¯¥è®ºæ–‡æå‡ºçš„æ–¹æ³•ä¸æˆ‘ä»¬çš„ç ”ç©¶æ–¹å‘é«˜åº¦ç›¸å…³ï¼Œå¯ä»¥ä½œä¸ºé‡è¦å‚è€ƒã€‚",
        domain: "è®ºæ–‡æ¶‰åŠçš„ç ”ç©¶é¢†åŸŸä¸å½“å‰é¡¹ç›®éœ€æ±‚åŒ¹é…ï¼Œå…·æœ‰è¾ƒå¥½çš„å‚è€ƒä»·å€¼ã€‚",
        application: "è®ºæ–‡ä¸­çš„åº”ç”¨åœºæ™¯ä¸æˆ‘ä»¬çš„ç›®æ ‡åº”ç”¨ç›¸ä¼¼ï¼Œå¯æä¾›æœ‰ç”¨çš„å®è·µç»éªŒã€‚",
        irrelevant: "ç»è¿‡åˆ†æï¼Œè¯¥è®ºæ–‡ä¸å½“å‰ç ”ç©¶éœ€æ±‚ç›¸å…³æ€§è¾ƒä½ï¼Œä¸ç¬¦åˆé¡¹ç›®è¦æ±‚ã€‚"
    };
    
    // ä¿å­˜ç›¸å…³åº¦
    function saveRelevance() {
        const arxivId = $('#edit-arxiv-id').val();
        const score = $('#relevance-score-input').val();
        const justification = $('#relevance-justification-input').val().trim();
        
        // éªŒè¯è¾“å…¥
        if (!score && !justification) {
            showSaveStatus('error', 'è¯·è‡³å°‘å¡«å†™è¯„åˆ†æˆ–ç†ç”±');
            return;
        }
        
        if (score && (parseFloat(score) < 0 || parseFloat(score) > 1)) {
            showSaveStatus('error', 'è¯„åˆ†å¿…é¡»åœ¨0-1ä¹‹é—´');
            return;
        }
        
        const saveBtn = $('#save-relevance-btn');
        const originalText = saveBtn.html();
        saveBtn.html('<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i> ä¿å­˜ä¸­...').prop('disabled', true);
        
        // å‡†å¤‡æ•°æ®
        const data = {
            arxiv_id: arxivId
        };
        
        if (score) {
            data.relevance_score = parseFloat(score);
        }
        
        if (justification) {
            data.relevance_justification = justification;
        }
        
        // å‘é€è¯·æ±‚
        $.ajax({
            url: '/api/update_relevance',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    showSaveStatus('success', 'ä¿å­˜æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°...');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showSaveStatus('error', response.error || 'ä¿å­˜å¤±è´¥');
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                showSaveStatus('error', error);
            },
            complete: function() {
                saveBtn.html(originalText).prop('disabled', false);
            }
        });
    }
    
    // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
    function showSaveStatus(type, message) {
        const statusDiv = $('#save-status');
        const messageSpan = $('#save-message');
        
        statusDiv.removeClass('alert-info alert-success alert-danger d-none');
        
        if (type === 'success') {
            statusDiv.addClass('alert-success');
            messageSpan.html(`<i class="bi bi-check-circle"></i> ${message}`);
        } else if (type === 'error') {
            statusDiv.addClass('alert-danger');
            messageSpan.html(`<i class="bi bi-exclamation-triangle"></i> ${message}`);
        } else {
            statusDiv.addClass('alert-info');
            messageSpan.html(`<i class="bi bi-info-circle"></i> ${message}`);
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåçš„äº‹ä»¶ç»‘å®š
    $(document).ready(function() {
        // æ£€æŸ¥é¡µé¢åŠ è½½æ—¶çš„æ·±åº¦åˆ†æçŠ¶æ€
        checkAndDisableIfProcessing();
        
        // å¿«æ·è¯„åˆ†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('[data-score]').click(function() {
            const score = $(this).data('score');
            $('#relevance-score-input').val(score);
            updateScorePreview();
        });
        
        // ç†ç”±æ¨¡æ¿æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('[data-template]').click(function() {
            const template = $(this).data('template');
            const textarea = $('#relevance-justification-input');
            const currentText = textarea.val().trim();
            const templateText = templates[template];
            
            if (currentText && !confirm('è¿™å°†æ›¿æ¢å½“å‰çš„ç†ç”±å†…å®¹ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                return;
            }
            
            textarea.val(templateText);
            updateCharCount();
        });
        
        // è¯„åˆ†è¾“å…¥å˜åŒ–äº‹ä»¶
        $('#relevance-score-input').on('input', function() {
            updateScorePreview();
        });
        
        // ç†ç”±æ–‡æœ¬å˜åŒ–äº‹ä»¶
        $('#relevance-justification-input').on('input', function() {
            updateCharCount();
        });
        
        // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('#save-relevance-btn').click(function() {
            saveRelevance();
        });
        
        // é”®ç›˜å¿«æ·é”®
        $('#relevanceEditModal').on('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveRelevance();
            }
        });
        
        // è‡ªå®šä¹‰æç¤ºè¯è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬
        const customPromptInput = document.getElementById('customPromptInput');
        if (customPromptInput) {
            // è¾“å…¥æ—¶æ›´æ–°å­—ç¬¦è®¡æ•°
            customPromptInput.addEventListener('input', updatePromptCharCount);
            
            // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°
            updatePromptCharCount();
        }
    });

    // Dify çŸ¥è¯†åº“æ“ä½œå‡½æ•°
    function uploadPaperToDify(arxivId) {
        const uploadSection = document.getElementById('dify-upload-section');
        const originalContent = uploadSection.innerHTML;
        
        // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
        uploadSection.innerHTML = `
            <button class="btn btn-info" disabled>
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">ä¸Šä¼ ä¸­...</span>
                </div>
                æ­£åœ¨ä¸Šä¼ åˆ°çŸ¥è¯†åº“...
            </button>
        `;
        
        fetch(`/api/dify_upload/${arxivId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('è®ºæ–‡ä¸Šä¼ æˆåŠŸï¼', 'success');
                // æ›´æ–°é¡µé¢æ˜¾ç¤ºä¸ºå·²ä¸Šä¼ çŠ¶æ€
                uploadSection.innerHTML = `
                    <button class="btn btn-success" disabled>
                        <i class="bi bi-cloud-check"></i> å·²ä¸Šä¼ åˆ°çŸ¥è¯†åº“
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="verifyDifyDocument('${arxivId}')">
                        <i class="bi bi-shield-check"></i> éªŒè¯æ–‡æ¡£
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="removePaperFromDify('${arxivId}')">
                        <i class="bi bi-trash"></i> ä»çŸ¥è¯†åº“ç§»é™¤
                    </button>
                `;
                
                // è‡ªåŠ¨éªŒè¯æ–‡æ¡£æ˜¯å¦çœŸæ­£ä¸Šä¼ æˆåŠŸ
                setTimeout(() => {
                    verifyDifyDocument(arxivId, true);
                }, 2000);
            } else {
                showAlert(`ä¸Šä¼ å¤±è´¥: ${data.error}`, 'error');
                // æ¢å¤åŸå§‹çŠ¶æ€
                uploadSection.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('ä¸Šä¼ å¤±è´¥:', error);
            showAlert('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
            // æ¢å¤åŸå§‹çŠ¶æ€
            uploadSection.innerHTML = originalContent;
        });
    }
    
    function removePaperFromDify(arxivId) {
        if (!confirm('ç¡®å®šè¦ä»çŸ¥è¯†åº“ä¸­ç§»é™¤è¿™ç¯‡è®ºæ–‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
            return;
        }
        
        const uploadSection = document.getElementById('dify-upload-section');
        const originalContent = uploadSection.innerHTML;
        
        // æ˜¾ç¤ºç§»é™¤çŠ¶æ€
        uploadSection.innerHTML = `
            <button class="btn btn-warning" disabled>
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">ç§»é™¤ä¸­...</span>
                </div>
                æ­£åœ¨ä»çŸ¥è¯†åº“ç§»é™¤...
            </button>
        `;
        
        fetch(`/api/dify_remove/${arxivId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('è®ºæ–‡å·²ä»çŸ¥è¯†åº“ç§»é™¤', 'success');
                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                uploadSection.innerHTML = `
                    <button class="btn btn-outline-success" onclick="uploadPaperToDify('${arxivId}')">
                        <i class="bi bi-cloud-upload"></i> ä¸Šä¼ åˆ°çŸ¥è¯†åº“
                    </button>
                `;
            } else {
                showAlert(`ç§»é™¤å¤±è´¥: ${data.error}`, 'error');
                // æ¢å¤åŸå§‹çŠ¶æ€
                uploadSection.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('ç§»é™¤å¤±è´¥:', error);
            showAlert('ç§»é™¤è¿‡ç¨‹ä¸­å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
            // æ¢å¤åŸå§‹çŠ¶æ€
            uploadSection.innerHTML = originalContent;
        });
    }
    
    function verifyDifyDocument(arxivId, isAutoVerify = false) {
        console.log(`å¼€å§‹éªŒè¯æ–‡æ¡£: ${arxivId}, è‡ªåŠ¨éªŒè¯: ${isAutoVerify}`);
        
        if (!isAutoVerify) {
            // æ˜¾ç¤ºéªŒè¯è¯´æ˜å¯¹è¯æ¡†
            const confirmMessage = `ç¡®å®šè¦éªŒè¯è¿™ç¯‡è®ºæ–‡åœ¨ Dify æœåŠ¡å™¨ä¸Šçš„çŠ¶æ€å—ï¼Ÿ\n\néªŒè¯å°†æ£€æŸ¥ï¼š\nâ€¢ æ–‡æ¡£æ˜¯å¦çœŸå®å­˜åœ¨äº Dify æœåŠ¡å™¨\nâ€¢ æ–‡æ¡£çš„ç´¢å¼•çŠ¶æ€å’Œå­—ç¬¦æ•°\nâ€¢ æœ¬åœ°è®°å½•ä¸æœåŠ¡å™¨çŠ¶æ€çš„ä¸€è‡´æ€§`;
            if (!confirm(confirmMessage)) {
                console.log('ç”¨æˆ·å–æ¶ˆäº†éªŒè¯æ“ä½œ');
                return;
            }
        }
        
        const uploadSection = document.getElementById('dify-upload-section');
        if (!uploadSection) {
            console.error('æ‰¾ä¸åˆ°dify-upload-sectionå…ƒç´ ');
            showAlert('é¡µé¢å…ƒç´ å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            return;
        }
        
        const originalContent = uploadSection.innerHTML;
        
        // æ˜¾ç¤ºæ›´æ¸…æ™°çš„éªŒè¯çŠ¶æ€
        uploadSection.innerHTML = `
            <div class="text-center p-3 border rounded bg-light">
                <div class="spinner-border text-primary mb-2" role="status">
                    <span class="visually-hidden">éªŒè¯ä¸­...</span>
                </div>
                <div class="fw-bold text-primary">æ­£åœ¨éªŒè¯æ–‡æ¡£çŠ¶æ€...</div>
                <small class="text-muted">è¿æ¥ Dify æœåŠ¡å™¨éªŒè¯æ–‡æ¡£å­˜åœ¨æ€§</small>
            </div>
        `;
        
        console.log(`å‘é€éªŒè¯è¯·æ±‚åˆ°: /api/dify_verify/${arxivId}`);
        
        fetch(`/api/dify_verify/${arxivId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('éªŒè¯å“åº”æ•°æ®:', data);
            
            if (data.success) {
                const result = data.data;
                console.log('éªŒè¯ç»“æœ:', result);
                
                if (result.verified) {
                    // éªŒè¯æˆåŠŸ - æ˜¾ç¤ºè¯¦ç»†çš„æˆåŠŸä¿¡æ¯
                    const info = result.document_info;
                    const successMessage = isAutoVerify ? 
                        'æ–‡æ¡£è‡ªåŠ¨éªŒè¯æˆåŠŸï¼' : 
                        `æ–‡æ¡£éªŒè¯æˆåŠŸï¼\n\néªŒè¯è¯¦æƒ…ï¼š\nâ€¢ æ–‡æ¡£çŠ¶æ€ï¼š${info?.status || 'æ­£å¸¸'}\nâ€¢ å­—ç¬¦æ•°ï¼š${info?.character_count || 'æœªçŸ¥'}\nâ€¢ ç´¢å¼•çŠ¶æ€ï¼š${info?.indexing_status || 'æœªçŸ¥'}`;
                    
                    showAlert(successMessage, 'success');
                    
                    uploadSection.innerHTML = `
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" disabled>
                                <i class="bi bi-cloud-check"></i> å·²ä¸Šä¼ åˆ°çŸ¥è¯†åº“
                                <span class="badge bg-light text-dark ms-1">âœ“ å·²éªŒè¯</span>
                            </button>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-info btn-sm" onclick="verifyDifyDocument('${arxivId}')" title="é‡æ–°éªŒè¯æ–‡æ¡£çŠ¶æ€">
                                    <i class="bi bi-shield-check"></i> é‡æ–°éªŒè¯
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="removePaperFromDify('${arxivId}')" title="ä»çŸ¥è¯†åº“ç§»é™¤">
                                    <i class="bi bi-trash"></i> ç§»é™¤
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // å¦‚æœä¸æ˜¯è‡ªåŠ¨éªŒè¯ï¼Œæ˜¾ç¤ºè¯¦ç»†çš„éªŒè¯ç»“æœ
                    if (!isAutoVerify && info) {
                        const detailsHtml = `
                            <div class="alert alert-success mt-2" role="alert">
                                <h6><i class="bi bi-check-circle"></i> éªŒè¯ç»“æœè¯¦æƒ…</h6>
                                <ul class="mb-0">
                                    <li><strong>æ–‡æ¡£åç§°ï¼š</strong>${info.dify_name || 'æœªçŸ¥'}</li>
                                    <li><strong>å­—ç¬¦æ•°ï¼š</strong>${info.character_count || 0}</li>
                                    <li><strong>æ–‡æ¡£çŠ¶æ€ï¼š</strong>${info.status || 'æœªçŸ¥'}</li>
                                    <li><strong>ç´¢å¼•çŠ¶æ€ï¼š</strong>${info.indexing_status || 'æœªçŸ¥'}</li>
                                </ul>
                            </div>
                        `;
                        uploadSection.insertAdjacentHTML('afterend', detailsHtml);
                        
                        // 3ç§’åè‡ªåŠ¨éšè—è¯¦æƒ…
                        setTimeout(() => {
                            const detailsAlert = uploadSection.nextElementSibling;
                            if (detailsAlert && detailsAlert.classList.contains('alert-success')) {
                                detailsAlert.remove();
                            }
                        }, 8000);
                    }
                    
                } else if (result.status === 'missing') {
                    // æ–‡æ¡£ä¸å­˜åœ¨ - æ˜¾ç¤ºè­¦å‘Šå’Œè§£å†³æ–¹æ¡ˆ
                    console.warn('æ–‡æ¡£åœ¨DifyæœåŠ¡å™¨ä¸Šä¸å­˜åœ¨');
                    showAlert('âš ï¸ éªŒè¯å¤±è´¥ï¼šæ–‡æ¡£åœ¨ Dify æœåŠ¡å™¨ä¸Šä¸å­˜åœ¨ï¼\n\nå¯èƒ½åŸå› ï¼š\nâ€¢ æ–‡æ¡£å·²è¢«æ‰‹åŠ¨åˆ é™¤\nâ€¢ çŸ¥è¯†åº“å·²è¢«é‡ç½®\nâ€¢ ç½‘ç»œä¼ è¾“å¼‚å¸¸\n\nå»ºè®®ï¼šé‡æ–°ä¸Šä¼ æˆ–æ¸…ç†æœ¬åœ°è®°å½•', 'warning');
                    
                    uploadSection.innerHTML = `
                        <div class="d-grid gap-2">
                            <div class="alert alert-warning mb-2" role="alert">
                                <i class="bi bi-exclamation-triangle"></i> 
                                <strong>çŠ¶æ€å¼‚å¸¸ï¼š</strong>æœåŠ¡å™¨ä¸Šä¸å­˜åœ¨æ­¤æ–‡æ¡£
                            </div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="uploadPaperToDify('${arxivId}')" title="é‡æ–°ä¸Šä¼ åˆ°çŸ¥è¯†åº“">
                                    <i class="bi bi-cloud-upload"></i> é‡æ–°ä¸Šä¼ 
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="cleanMissingDifyRecord('${arxivId}')" title="æ¸…ç†æœ¬åœ°é”™è¯¯è®°å½•">
                                    <i class="bi bi-eraser"></i> æ¸…ç†è®°å½•
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="verifyDifyDocument('${arxivId}')" title="é‡æ–°éªŒè¯">
                                    <i class="bi bi-arrow-repeat"></i> é‡è¯•éªŒè¯
                                </button>
                            </div>
                        </div>
                    `;
                    
                } else if (result.status === 'not_uploaded') {
                    // æœªä¸Šä¼ çŠ¶æ€
                    console.info('æ–‡æ¡£å°šæœªä¸Šä¼ åˆ°Dify');
                    showAlert('â„¹ï¸ éªŒè¯ç»“æœï¼šæ–‡æ¡£å°šæœªä¸Šä¼ åˆ° Dify çŸ¥è¯†åº“', 'info');
                    uploadSection.innerHTML = `
                        <button class="btn btn-outline-success" onclick="uploadPaperToDify('${arxivId}')">
                            <i class="bi bi-cloud-upload"></i> ä¸Šä¼ åˆ°çŸ¥è¯†åº“
                        </button>
                    `;
                } else {
                    // æœªçŸ¥çŠ¶æ€
                    console.warn('æœªçŸ¥çš„éªŒè¯çŠ¶æ€:', result.status);
                    showAlert(`âš ï¸ éªŒè¯é‡åˆ°æœªçŸ¥çŠ¶æ€: ${result.status}\n\nå»ºè®®ï¼šç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜`, 'warning');
                    uploadSection.innerHTML = originalContent;
                }
                
            } else {
                console.error('éªŒè¯å¤±è´¥:', data.error);
                showAlert(`âŒ éªŒè¯å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•`, 'error');
                // æ¢å¤åŸå§‹çŠ¶æ€
                uploadSection.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('éªŒè¯è¯·æ±‚å¤±è´¥:', error);
            let errorMessage;
            if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                errorMessage = 'âŒ ç½‘ç»œè¿æ¥é”™è¯¯\n\nè¯·æ£€æŸ¥ï¼š\nâ€¢ ç½‘ç»œè¿æ¥çŠ¶æ€\nâ€¢ Dify æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ\nâ€¢ é˜²ç«å¢™è®¾ç½®';
            } else if (error.message.includes('500')) {
                errorMessage = 'âŒ æœåŠ¡å™¨å†…éƒ¨é”™è¯¯\n\nè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜';
            } else {
                errorMessage = `âŒ éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯\n\né”™è¯¯è¯¦æƒ…ï¼š${error.message}`;
            }
            showAlert(errorMessage, 'error');
            // æ¢å¤åŸå§‹çŠ¶æ€
            uploadSection.innerHTML = originalContent;
        });
    }
    
    function cleanMissingDifyRecord(arxivId) {
        if (!confirm('ç¡®å®šè¦æ¸…ç†è¿™ç¯‡è®ºæ–‡çš„ Dify è®°å½•å—ï¼Ÿæ¸…ç†åè®ºæ–‡çŠ¶æ€å°†é‡ç½®ä¸ºæœªä¸Šä¼ ã€‚')) {
            return;
        }
        
        const uploadSection = document.getElementById('dify-upload-section');
        const originalContent = uploadSection.innerHTML;
        
        // æ˜¾ç¤ºæ¸…ç†çŠ¶æ€
        uploadSection.innerHTML = `
            <button class="btn btn-warning" disabled>
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">æ¸…ç†ä¸­...</span>
                </div>
                æ­£åœ¨æ¸…ç†è®°å½•...
            </button>
        `;
        
        fetch(`/api/dify_clean/${arxivId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('è®°å½•æ¸…ç†æˆåŠŸï¼è®ºæ–‡çŠ¶æ€å·²é‡ç½®ä¸ºæœªä¸Šä¼ ', 'success');
                uploadSection.innerHTML = `
                    <button class="btn btn-outline-success" onclick="uploadPaperToDify('${arxivId}')">
                        <i class="bi bi-cloud-upload"></i> ä¸Šä¼ åˆ°çŸ¥è¯†åº“
                    </button>
                `;
            } else {
                showAlert(`æ¸…ç†å¤±è´¥: ${data.error}`, 'error');
                // æ¢å¤åŸå§‹çŠ¶æ€
                uploadSection.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('æ¸…ç†å¤±è´¥:', error);
            showAlert('æ¸…ç†è¿‡ç¨‹ä¸­å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
            // æ¢å¤åŸå§‹çŠ¶æ€
            uploadSection.innerHTML = originalContent;
        });
    }

    // æ˜¾ç¤ºæç¤ºä¿¡æ¯å‡½æ•°
    function showAlert(message, type = 'success', duration = 5000) {
        // åˆ›å»ºæç¤ºå…ƒç´ 
        const alert = document.createElement('div');
        alert.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px; max-width: 500px; animation: slideInRight 0.3s ease;';
        
        // æ·»åŠ å›¾æ ‡
        let icon = '';
        switch(type) {
            case 'success': icon = '<i class="bi bi-check-circle-fill"></i>'; break;
            case 'error': case 'danger': icon = '<i class="bi bi-exclamation-triangle-fill"></i>'; break;
            case 'warning': icon = '<i class="bi bi-exclamation-circle-fill"></i>'; break;
            case 'info': icon = '<i class="bi bi-info-circle-fill"></i>'; break;
            default: icon = '<i class="bi bi-info-circle-fill"></i>';
        }
        
        // å¤„ç†æ¢è¡Œç¬¦
        const formattedMessage = message.replace(/\n/g, '<br>');
        
        alert.innerHTML = `
            ${icon} <span>${formattedMessage}</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alert);
        
        // è‡ªåŠ¨åˆ é™¤
        setTimeout(() => {
            if (alert.parentNode) {
                alert.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }
        }, duration);
        
        return alert;
    }

    // å¯¼å‡ºè®ºæ–‡æ•°æ®
    /*
    function exportPaperData() {
        const paperData = {
            arxiv_id: '{{ paper.arxiv_id }}',
            title: '{{ paper.title|e }}',
            authors: '{{ paper.authors|e }}',
            abstract: '{{ paper.abstract|e }}',
            categories: '{{ paper.categories }}',
            published_date: '{{ paper.published_date }}',
            pdf_url: '{{ paper.pdf_url }}',
            processing_status: '{{ paper.processing_status }}',
            research_background: '{{ paper.research_background|e }}',
            research_objectives: '{{ paper.research_objectives|e }}',
            methods: '{{ paper.methods|e }}',
            key_findings: '{{ paper.key_findings|e }}',
            conclusions: '{{ paper.conclusions|e }}',
            limitations: '{{ paper.limitations|e }}',
            future_work: '{{ paper.future_work|e }}',
            keywords: '{{ paper.keywords|e }}',
            tags: {{ paper.tags|tojson }},
            metadata: {{ paper.metadata|tojson }},
            created_at: '{{ paper.created_at }}',
            updated_at: '{{ paper.updated_at }}'
        };
        
        const dataStr = JSON.stringify(paperData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `${paperData.arxiv_id}_data.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('è®ºæ–‡æ•°æ®å·²å¯¼å‡º', 'success');
    }
    */
    
    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        // å¦‚æœæ­£åœ¨ç¼–è¾‘ç›¸å…³åº¦æ¨¡æ€æ¡†ï¼Œä¸å¤„ç†å¯¼èˆªå¿«æ·é”®
        if (document.getElementById('relevanceEditModal').classList.contains('show')) {
            return;
        }
        
        // ESC é”®è¿”å›åˆ—è¡¨
        if (e.key === 'Escape') {
            window.location.href = '{{ url_for("explore.papers") }}';
        }
        
        // P é”®æ‰“å¼€PDFï¼ˆå¦‚æœæœ‰ï¼‰
        if (e.key === 'p' || e.key === 'P') {
            // {% if paper.pdf_url %}
            window.open('{{ paper.pdf_url }}', '_blank');
            // {% endif %}
        }
        
        // å·¦ç®­å¤´é”®ï¼šä¸Šä¸€ç¯‡è®ºæ–‡
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            // {% if navigation.previous %}
            window.location.href = '{{ url_for("explore.paper_detail", arxiv_id=navigation.previous.arxiv_id) }}';
            // {% else %}
            showAlert('å·²æ˜¯ç¬¬ä¸€ç¯‡è®ºæ–‡', 'info');
            // {% endif %}
        }
        
        // å³ç®­å¤´é”®ï¼šä¸‹ä¸€ç¯‡è®ºæ–‡
        if (e.key === 'ArrowRight') {
            e.preventDefault();
            // {% if navigation.next %}
            window.location.href = '{{ url_for("explore.paper_detail", arxiv_id=navigation.next.arxiv_id) }}';
            // {% else %}
            showAlert('å·²æ˜¯æœ€åä¸€ç¯‡è®ºæ–‡', 'info');
            // {% endif %}
        }
    });
    
    // ä»»åŠ¡è¿ç§»ç›¸å…³å˜é‡ (ä½¿ç”¨ä¸åŒçš„åç§°é¿å…ä¸main.jså†²çª)
    let paperDetailAvailableTasks = [];
    let paperDetailFilteredTasks = [];
    let paperDetailSelectedTask = null;
    
    // è¾…åŠ©å‡½æ•°ï¼šHTMLè½¬ä¹‰
    function escapeHtml(text) {
        if (typeof text !== 'string') return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateString) {
        if (!dateString) return '';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        } catch (e) {
            return dateString;
        }
    }
    
    // æ‰“å¼€è¿ç§»æ¨¡æ€æ¡†
    function openMigrationModal(arxivId, paperTitle) {
        document.getElementById('migrationPaperTitle').textContent = paperTitle;
        
        // å­˜å‚¨å½“å‰è®ºæ–‡çš„arxiv_id
        window.currentMigrationArxivId = arxivId;
        
        // é‡ç½®çŠ¶æ€
        paperDetailSelectedTask = null;
        document.getElementById('confirmMigrationBtn').disabled = true;
        hideMigrationStatus();
        
        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        loadTasksForMigration();
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('migrationModal'));
        modal.show();
    }
    
    // åŠ è½½å¯ç”¨äºè¿ç§»çš„ä»»åŠ¡
    function loadTasksForMigration() {
        const container = document.getElementById('taskListContainer');
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                </div>
                <p class="mt-2">æ­£åœ¨åŠ è½½ä»»åŠ¡åˆ—è¡¨...</p>
            </div>
        `;
        
        fetch('/api/tasks/available_for_migration')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    paperDetailAvailableTasks = data.data.tasks || [];
                    paperDetailFilteredTasks = [...paperDetailAvailableTasks];
                    renderTaskList();
                } else {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•
                    </div>
                `;
            });
    }
    
    // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
    function renderTaskList() {
        const container = document.getElementById('taskListContainer');
        
        if (paperDetailFilteredTasks.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    ${paperDetailAvailableTasks.length === 0 ? 'æš‚æ— å¯ç”¨ä»»åŠ¡' : 'æœç´¢ç»“æœä¸ºç©º'}
                </div>
            `;
            return;
        }
        
        const tasksHtml = paperDetailFilteredTasks.map(task => `
            <div class="task-option border rounded p-3 mb-2 cursor-pointer" data-task='${JSON.stringify(task)}'>
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <strong>${escapeHtml(task.task_name)}</strong>
                            ${task.task_id ? `<span class="text-muted small">(${escapeHtml(task.task_id)})</span>` : ''}
                        </h6>
                        <div class="small text-muted">
                            <i class="bi bi-file-text"></i> ${task.paper_count || 0} ç¯‡è®ºæ–‡
                            ${task.top_categories && task.top_categories.length > 0 ? 
                                `<span class="ms-2"><i class="bi bi-tags"></i> ${task.top_categories.slice(0, 3).map(cat => escapeHtml(cat)).join(', ')}</span>` 
                                : ''
                            }
                        </div>
                        ${task.created_at ? `<div class="small text-muted mt-1"><i class="bi bi-calendar"></i> ${formatDate(task.created_at)}</div>` : ''}
                    </div>
                    <div class="text-end">
                        <button class="btn btn-outline-primary btn-sm select-task-btn">é€‰æ‹©</button>
                    </div>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = tasksHtml;
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        container.querySelectorAll('.task-option').forEach(taskElement => {
            taskElement.addEventListener('click', function() {
                selectTaskForMigration(this);
            });
        });
    }
    
    // é€‰æ‹©ä»»åŠ¡
    function selectTaskForMigration(taskElement) {
        // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
        document.querySelectorAll('.task-option').forEach(el => {
            el.classList.remove('border-primary', 'bg-light');
            el.querySelector('.select-task-btn').textContent = 'é€‰æ‹©';
            el.querySelector('.select-task-btn').className = 'btn btn-outline-primary btn-sm select-task-btn';
        });
        
        // é«˜äº®å½“å‰é€‰æ‹©
        taskElement.classList.add('border-primary', 'bg-light');
        const selectBtn = taskElement.querySelector('.select-task-btn');
        selectBtn.textContent = 'å·²é€‰æ‹©';
        selectBtn.className = 'btn btn-primary btn-sm select-task-btn';
        
        // å­˜å‚¨é€‰æ‹©çš„ä»»åŠ¡
        paperDetailSelectedTask = JSON.parse(taskElement.dataset.task);
        
        // å¯ç”¨ç¡®è®¤æŒ‰é’®
        document.getElementById('confirmMigrationBtn').disabled = false;
    }
    
    // è¿‡æ»¤ä»»åŠ¡åˆ—è¡¨
    function filterTasks() {
        const searchTerm = document.getElementById('taskSearchInput').value.toLowerCase().trim();
        paperDetailFilteredTasks = paperDetailAvailableTasks.filter(task => 
            task.task_name.toLowerCase().includes(searchTerm) ||
            (task.task_id && task.task_id.toLowerCase().includes(searchTerm)) ||
            (task.top_categories && task.top_categories.some(cat => cat.toLowerCase().includes(searchTerm)))
        );
        renderTaskList();
        
        // æ¸…é™¤é€‰æ‹©çŠ¶æ€
        paperDetailSelectedTask = null;
        document.getElementById('confirmMigrationBtn').disabled = true;
    }
    
    // ç¡®è®¤è¿ç§»
    function confirmMigration() {
        if (!paperDetailSelectedTask || !window.currentMigrationArxivId) {
            showMigrationStatus('error', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»»åŠ¡');
            return;
        }
        
        const confirmBtn = document.getElementById('confirmMigrationBtn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i> è¿ç§»ä¸­...';
        confirmBtn.disabled = true;
        
        fetch('/api/migrate_paper_to_task', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                arxiv_id: window.currentMigrationArxivId,
                target_task_name: paperDetailSelectedTask.task_name,
                target_task_id: paperDetailSelectedTask.task_id || null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMigrationStatus('success', 'è®ºæ–‡è¿ç§»æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°...');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showMigrationStatus('error', data.error || 'è¿ç§»å¤±è´¥');
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('è¿ç§»è¯·æ±‚å¤±è´¥:', error);
            showMigrationStatus('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        });
    }
    
    // æ˜¾ç¤ºè¿ç§»çŠ¶æ€
    function showMigrationStatus(type, message) {
        const statusDiv = document.getElementById('migrationStatus');
        const messageSpan = document.getElementById('migrationStatusMessage');
        
        statusDiv.className = 'alert mt-3';
        
        if (type === 'success') {
            statusDiv.classList.add('alert-success');
            messageSpan.innerHTML = `<i class="bi bi-check-circle"></i> ${message}`;
        } else if (type === 'error') {
            statusDiv.classList.add('alert-danger');
            messageSpan.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${message}`;
        } else {
            statusDiv.classList.add('alert-info');
            messageSpan.innerHTML = `<i class="bi bi-info-circle"></i> ${message}`;
        }
    }
    
    // éšè—è¿ç§»çŠ¶æ€
    function hideMigrationStatus() {
        const statusDiv = document.getElementById('migrationStatus');
        statusDiv.className = 'alert d-none mt-3';
    }
    
    // å·¥å…·å‡½æ•°ï¼šHTMLè½¬ä¹‰
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateString) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        } catch {
            return dateString;
        }
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success', 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                fallbackCopyTextToClipboard(text);
            });
        } else {
            fallbackCopyTextToClipboard(text);
        }
    }
    
    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showAlert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success', 2000);
            } else {
                showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            }
        } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
        }
        
        document.body.removeChild(textArea);
    }

    // æµ‹è¯•å‡½æ•° - éªŒè¯JavaScriptæ˜¯å¦æ­£å¸¸å·¥ä½œ
    function testDeepAnalysisButton(arxivId) {
        console.log('æµ‹è¯•å‡½æ•°è¢«è°ƒç”¨äº†ï¼');
        alert('JavaScriptæ­£å¸¸å·¥ä½œï¼arxivId: ' + arxivId);
    }
    
    // å…¨å±€å‡½æ•°æ£€æŸ¥
    window.testGlobalFunction = function() {
        console.log('å…¨å±€å‡½æ•°æ£€æŸ¥é€šè¿‡');
        return true;
    };
    
    // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
        console.log('window.startDeepAnalysiså­˜åœ¨:', typeof window.startDeepAnalysis === 'function');
        console.log('window.cancelDeepAnalysiså­˜åœ¨:', typeof window.cancelDeepAnalysis === 'function');
        
        // æ£€æŸ¥æ·±åº¦åˆ†ææŒ‰é’®æ˜¯å¦å­˜åœ¨
        const deepAnalysisSection = document.getElementById('deep-analysis-section');
        if (deepAnalysisSection) {
            console.log('âœ… æ‰¾åˆ°æ·±åº¦åˆ†æåŒºåŸŸ');
            const buttons = deepAnalysisSection.querySelectorAll('button, a');
            console.log('æ‰¾åˆ°æŒ‰é’®æ•°é‡:', buttons.length);
            buttons.forEach((btn, index) => {
                console.log(`æŒ‰é’®${index + 1}:`, btn.textContent.trim(), 'onclick:', btn.onclick ? 'function' : btn.getAttribute('onclick'));
            });
        } else {
            console.error('âŒ æœªæ‰¾åˆ°deep-analysis-sectionå…ƒç´ ');
        }
        
        // æµ‹è¯•å…¨å±€å‡½æ•°æ˜¯å¦å¯è°ƒç”¨
        if (typeof window.startDeepAnalysis === 'function') {
            console.log('âœ… window.startDeepAnalysis å¯ç”¨');
        } else {
            console.error('âŒ window.startDeepAnalysis ä¸å¯ç”¨');
        }
    });
</script>
{% endblock %}
